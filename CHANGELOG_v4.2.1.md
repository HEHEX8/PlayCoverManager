# PlayCover Complete Manager v4.2.1 変更ログ

## リリース日: 2025-10-25

## 🎯 主要な改善: IPA インストール検出の堅牢化（実環境ベース修正版）

### 背景
v4.1.0までは、ファイル修正時間(mtime)の安定性のみでインストール完了を判定していました。この方法は一般的に機能しますが、より確実な検出方法が求められていました。

v4.2.0では、PlayCover.sqliteデータベースを使用した検証を実装しましたが、実際のユーザー環境を確認したところ、**PlayCoverはSQLiteデータベースではなく、ファイルシステムベースで管理している**ことが判明しました。

v4.2.1では、実際のPlayCoverコンテナ構造に基づいた正確な実装に修正しました。

### 実装した改善

#### 1. 3段階検証システムの導入（実環境ベース）

**Phase 1: 構造検証（必須）**
```bash
# Info.plist の有効性確認
- CFBundleName の取得
- CFBundleShortVersionString の取得
- _CodeSignature ディレクトリの存在確認
```

**Phase 2: PlayCover 設定ファイル確認（最も信頼性が高い）**
```bash
# 実際のPlayCoverコンテナ構造に基づく検証
- パス: ~/Library/Containers/io.playcover.PlayCover/App Settings/
- ファイル: [Bundle ID].plist の存在確認
- PlayCover によるアプリ登録の証明

# 実環境での構造（ユーザー提供のtree出力より）:
io.playcover.PlayCover/
├── App Settings/
│   ├── com.HoYoverse.hkrpgoversea.plist
│   ├── com.HoYoverse.Nap.plist
│   └── com.miHoYo.GenshinImpact.plist
└── Applications/
    ├── com.HoYoverse.hkrpgoversea.app
    └── com.HoYoverse.Nap.app
```

**Phase 3: ファイル安定性確認（短縮版）**
```bash
# mtime 安定性チェック
- 従来: 3回チェック × 3秒 = 9秒待機
- 新方式: 2回チェック × 3秒 = 6秒待機
- 待機時間を33%短縮
```

#### 2. 成功判定ロジック

```
成功条件: Phase 1 ✓ AND (Phase 2 ✓ OR Phase 3 ✓)
```

**シナリオ別の動作:**

| シナリオ | Phase 1 | Phase 2 | Phase 3 | 結果 | 待機時間 |
|---------|---------|---------|---------|------|---------|
| 理想的なケース | ✓ | ✓ | - | 成功 | ほぼ即座 (3秒) |
| 設定未作成 | ✓ | ✗ | ✓ | 成功 | 6秒 |
| 構造未完成 | ✗ | - | - | 継続 | 次のチェックへ |

#### 3. クラッシュ時の検証強化

PlayCoverがクラッシュした場合も同様の3段階検証を実施：
- 構造の完全性を確認
- 設定ファイルの存在を確認
- どちらかが確認できれば「クラッシュしたが成功」と判定

### コード変更箇所

**ファイル**: `playcover-complete-manager.command`

1. **検出ロジックの置き換え** (lines 926-949)
   - 旧: mtime安定性のみ (9秒)
   - 新: 3段階検証 (設定ファイル確認で即座、またはmtimeで6秒)

2. **クラッシュ時検証の強化** (lines 965-997)
   - App Settings/*.plist の存在確認
   - 構造完全性を確認
   - フォールバック対応を追加

3. **メインループ検証** (lines 1033-1110)
   - Phase 1: 構造検証
   - Phase 2: 設定ファイル検証
   - Phase 3: mtime検証（短縮）
   - 複合判定ロジック

### 技術的な詳細

#### PlayCover ファイルシステム構造（実環境）
```bash
~/Library/Containers/io.playcover.PlayCover/
├── App Settings/           # アプリごとの設定ファイル
│   └── [BundleID].plist   # PlayCoverによる登録の証明
├── Applications/           # インストールされたアプリ
│   └── [BundleID].app
├── Entitlements/          # 権限設定
└── Keymapping/            # キーマッピング設定

# 検証方法:
if [[ -f "${HOME}/Library/Containers/io.playcover.PlayCover/App Settings/${BUNDLE_ID}.plist" ]]; then
    # PlayCoverによる登録完了
fi
```

#### エラーハンドリング
- 設定ファイル未作成時: 構造+mtime検証でフォールバック
- アプリバンドル不在: 継続的な検証ループ
- 構造不完全時: タイムアウトまで待機

### パフォーマンス改善

1. **検出時間の短縮**
   - 最良ケース: ほぼ即座（設定ファイル確認で完了）
   - 通常ケース: 6秒（従来より3秒短縮）
   - 最悪ケース: 変わらず（タイムアウト300秒）

2. **信頼性の向上**
   - 実環境の構造に基づく正確な検証
   - PlayCoverの実際の動作に沿った実装
   - 複数の検証方法によるフォールバック

### 後方互換性

- 既存のマッピングファイルと完全互換
- playcover-map.txt の形式変更なし
- 既存の環境で即座に使用可能

### テスト推奨事項

実環境でテストすべきシナリオ：

1. **通常インストール**
   - 新規IPA → 設定ファイル確認で即座に完了
   
2. **上書きインストール**
   - 既存アプリの更新 → 設定ファイル更新確認

3. **PlayCoverクラッシュ**
   - インストール中のクラッシュ → 構造+設定ファイル確認で成功判定

4. **バッチインストール**
   - 複数IPAの連続インストール → 各IPAで正確な検出

5. **設定ファイル未作成（稀なケース）**
   - 設定ファイル未作成時 → 構造+mtime検証にフォールバック

### ユーザーへの影響

**ポジティブな影響:**
- ✅ インストール完了が早く確実に検出される
- ✅ 待機時間が短縮される（9秒→6秒、または設定ファイル確認で即座）
- ✅ 偽検出が減少する
- ✅ クラッシュ時の判定がより正確になる
- ✅ 実環境の構造に基づく正確な実装

**注意事項:**
- ⚠️ PlayCoverコンテナへのアクセス権限が必要（通常は問題なし）

### バージョン更新内容

```
v4.2.0 → v4.2.1 (実環境ベース修正)
- PlayCover.sqlite 依存を削除
- App Settings/*.plist ベースの検証に変更
- 行数: 2966行（微調整のみ）
- サイズ: 107KB
- 実環境での動作保証を強化
```

### 次回以降の改善案

1. **設定ファイル内容の検証**
   - .plist内部のバージョン情報確認

2. **インストールプログレスの可視化**
   - Phase 1/2/3 の進行状況を表示

3. **デバッグモード**
   - 各Phaseの詳細なログ出力オプション

---

## まとめ

v4.2.1では、実際のユーザー環境に基づいてIPAインストール検出ロジックを修正しました。PlayCoverは実際にはSQLiteデータベースではなくファイルシステムベースで管理しており、`App Settings/` ディレクトリ内の `.plist` ファイルがアプリ登録の証明となります。

この修正により、v4.2.0で誤って実装されたデータベース依存を削除し、実環境で確実に動作する検証ロジックを実現しました。

**v4.2.0からの修正点:**
- ❌ 誤: `PlayCover.sqlite` データベース確認（実際には存在しない）
- ✅ 正: `App Settings/[BundleID].plist` ファイル確認（実環境で確認済み）

**推奨**: v4.2.0をお使いの方は v4.2.1 へのアップグレードを推奨します。実環境に基づく正確な実装により、より確実なインストール検出が可能になります。
