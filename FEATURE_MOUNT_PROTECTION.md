# 新機能 v1.4.0 - マウント保護機能

## 🛡️ 概要

**内蔵ストレージにデータが存在する場合、外部ボリュームのマウントをブロックする安全機能を追加しました。**

---

## 🎯 目的

### 問題

内蔵ストレージにデータがある状態で、外部ボリュームを同じ場所にマウントしようとすると：

1. **データ損失のリスク**
   - 内蔵データが見えなくなる
   - 外部ボリュームのデータで上書きされる可能性

2. **混乱を招く**
   - どちらのデータが使われているか不明確
   - アプリが予期しない動作をする

### 解決策

**マウント保護機能** により、以下を実現：

- ✅ 内蔵データが存在する場合、外部ボリュームのマウントを**自動ブロック**
- ✅ 明確なエラーメッセージと解決方法を表示
- ✅ データ損失のリスクを排除

---

## 🔒 動作の詳細

### 保護ロジック

```bash
# mount_volume() 関数内で実行
if [[ -d "$target_path" ]]; then
    local mount_check=$(/sbin/mount | /usr/bin/grep " on ${target_path} ")
    if [[ -z "$mount_check" ]]; then
        # ディレクトリが存在 + マウントポイントではない
        # = 内蔵ストレージにデータが存在
        → マウントをブロック
    fi
fi
```

### 判定基準

| 状態 | 判定 | 動作 |
|-----|------|------|
| ディレクトリなし | 安全 | ✅ マウント許可 |
| ディレクトリあり + マウント中 | 既にマウント済み | ✅ スキップ |
| ディレクトリあり + マウントなし | **内蔵データあり** | ❌ **マウントブロック** |

---

## 💬 ユーザーメッセージ

### ブロック時の表示

```
❌ マウントがブロックされました
⚠ このアプリは現在、内蔵ストレージで動作しています
ℹ 外部ボリュームをマウントする前に、以下を実行してください:

  1. ストレージ切り替え機能（オプション6）を使用
  2. 「内蔵 → 外部」への切り替えを実行

または、内蔵データを手動でバックアップしてから削除:
  sudo mv "~/Library/Containers/com.xxx.xxx" "~/Library/Containers/com.xxx.xxx.backup"
```

---

## 📊 使用シナリオ

### シナリオ1: 正常な切り替えフロー（推奨）

```bash
# 1. ZZZが内蔵ストレージで動作中
💾 ゼンレスゾーンゼロ (内蔵ストレージ)

# 2. 「全ボリュームをマウント」を実行
→ ❌ ZZZの外部ボリュームマウントがブロックされる
→ 他のアプリは正常にマウント

# 3. ストレージ切り替え機能を使用（オプション6）
→ 「内蔵 → 外部」を選択
→ データが安全にコピーされる
→ 内蔵データは自動バックアップ
→ 外部ボリュームが正常にマウント

# 4. 再度「全ボリュームをマウント」を実行
→ ✅ すべて正常にマウント
```

### シナリオ2: 手動バックアップ（上級者向け）

```bash
# 1. 内蔵データを手動バックアップ
sudo mv ~/Library/Containers/com.HoYoverse.Nap \
        ~/Library/Containers/com.HoYoverse.Nap.backup

# 2. 外部ボリュームをマウント
→ ✅ マウント成功

# 3. 動作確認後、バックアップを削除
sudo rm -rf ~/Library/Containers/com.HoYoverse.Nap.backup
```

---

## 🔍 技術詳細

### 実装箇所

**ファイル**: `2_playcover-volume-manager.command`  
**関数**: `mount_volume()`  
**行数**: 約190-210行

### 保護チェックのタイミング

```
1. ボリュームの存在確認
2. デバイスノードの取得
3. 【NEW】内蔵データの保護チェック ← ここで追加
4. 現在のマウント状態確認
5. マウント実行
```

### 影響を受ける操作

以下の操作で保護機能が働きます：

1. **全ボリュームをマウント（オプション1）**
   - 内蔵データがあるアプリはスキップ
   - 他のアプリは正常にマウント

2. **個別ボリューム操作（オプション3）**
   - マウント時に保護チェック
   - ブロックされた場合、詳細メッセージを表示

3. **PlayCover メインボリューム自動マウント**
   - 個別マウント時の自動マウントも保護対象

### 影響を受けない操作

以下の操作は保護の対象外：

- ❌ アンマウント（オプション2）
- ❌ ストレージ切り替え（オプション6） - 安全な切り替えを実行
- ❌ ディスク取り外し（オプション5）

---

## 🧪 テストケース

### テスト1: 内蔵データありでマウント試行

**準備:**
```bash
# ZZZを内蔵ストレージに切り替え済み
ls ~/Library/Containers/com.HoYoverse.Nap
# ディレクトリ存在 + マウントポイントではない
```

**実行:**
```bash
./2_playcover-volume-manager.command
# オプション 1 を選択（全ボリュームをマウント）
```

**期待される結果:**
```
✓ 崩壊：スターレイル をマウントしました
✓ 原神 をマウントしました
❌ マウントがブロックされました
⚠ このアプリは現在、内蔵ストレージで動作しています
...（解決方法が表示される）
```

### テスト2: 外部ボリュームマウント済み

**準備:**
```bash
# ZZZが既に外部ボリュームでマウント済み
mount | grep com.HoYoverse.Nap
# /dev/disk5s4 on ~/Library/Containers/com.HoYoverse.Nap (apfs)
```

**実行:**
```bash
# オプション 1 を選択
```

**期待される結果:**
```
✓ ゼンレスゾーンゼロ は既に正しい位置にマウントされています
```

### テスト3: データなし（新規）

**準備:**
```bash
# ディレクトリが存在しない
ls ~/Library/Containers/com.NewApp.Test
# No such file or directory
```

**実行:**
```bash
# 新規アプリをマウント
```

**期待される結果:**
```
ℹ 新規アプリ をマウント中...
✓ 新規アプリ をマウントしました
```

---

## ⚠️ 注意事項

### 1. ストレージ切り替え機能を推奨

手動でのデータ移動ではなく、**ストレージ切り替え機能（オプション6）** を使用することを強く推奨します：

- ✅ 自動バックアップ
- ✅ エラー時の自動ロールバック
- ✅ データ整合性の保証
- ✅ 権限の自動設定

### 2. 手動削除のリスク

内蔵データを手動で削除する場合：

- ⚠️ **必ずバックアップを作成**
- ⚠️ アプリを終了してから実行
- ⚠️ 削除後の復元は困難

### 3. 既存の動作への影響

**既存のワークフローへの影響は最小限:**

- ✅ 通常の外部ボリュームマウントは影響なし
- ✅ 既にマウント済みの場合は影響なし
- ✅ 内蔵データがない場合は影響なし

**影響があるのは:**

- ⚠️ 内蔵にデータがある状態で外部ボリュームをマウントしようとした場合のみ

---

## 🎯 メリット

### 1. データ保護

- ✅ 内蔵データの意図しない上書きを防止
- ✅ データ損失のリスクを大幅に削減

### 2. ユーザー体験の向上

- ✅ 明確なエラーメッセージ
- ✅ 具体的な解決方法の提示
- ✅ 混乱を防ぐ

### 3. 安全性の向上

- ✅ 誤操作による被害を防止
- ✅ 適切なワークフローへの誘導

---

## 📝 まとめ

### 変更内容

| 項目 | 内容 |
|-----|------|
| 機能 | マウント保護機能 |
| バージョン | v1.4.0 |
| 影響範囲 | `mount_volume()` 関数 |
| 追加行数 | 約20行 |

### 動作

```
内蔵データあり + 外部マウント試行
    ↓
❌ マウントブロック
    ↓
解決方法を表示:
  - ストレージ切り替え機能を使用（推奨）
  - 手動バックアップ（上級者向け）
```

---

## ✅ 検証

```bash
bash -n 2_playcover-volume-manager.command
# ✅ 構文エラーなし
```

---

**安全性が大幅に向上しました！** 🛡️✨

---

**実装日**: 2025-01-XX  
**バージョン**: v1.4.0  
**実装者**: AI Assistant  
**ステータス**: ✅ 実装完了・テスト準備完了
