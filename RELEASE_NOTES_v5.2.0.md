# PlayCover Manager v5.2.0 変更点まとめ (CLI版)

## 📋 v5.1.0 → v5.2.0 の変更内容

> **注意**: v5.2.0以降、CLI版として特化しました。このCLI版をベースに、完全な上位互換版である[PlayCover Manager GUI](https://github.com/HEHEX8/PlayCoverManagerGUI)が別リポジトリで利用可能です。
> 
> **プロジェクト関係**: GUI版は、この親プロジェクト（CLI版、9,000+行のZshスクリプト）の全機能を継承し、SwiftUIネイティブアプリとして完全に再実装した超進化版です。

---

## 🆕 新機能

### 1. **システムメンテナンスメニュー**
macOSのストレージ容量問題を解決する新機能を追加

- **APFSスナップショットの確認・削除**
  - Time Machineのローカルスナップショットを削除して容量を回復
  - 「幽霊容量」問題の解決（データ削除後も容量が減らない現象）
  
- **システムキャッシュのクリア**
  - ユーザーキャッシュ、一時ファイル、ダウンロード済みアップデートを削除
  
- **ストレージ使用状況の確認**
  - システムボリュームと外部ボリュームの容量を表示

メインメニューに `[6] システムメンテナンス` を追加

---

## 🐛 バグ修正

### 1. **プログレスバー表示の修正**
rsync転送中にリアルタイムでプログレスバーが表示されるように修正

- `monitor_file_progress()`関数の出力を`stderr`にリダイレクト
- プログレスバーが戻り値で上書きされる問題を解決
- `[████████░░] 80% | 4758/5948 files | 52 files/s` 形式で表示

---

### 2. **シングルインスタンス実装の完成**
複数の試行錯誤を経て、正しい実装を達成

**最終的な設計:**
- **ランチャー**: ロックファイルを読み取り専用でチェック。既存インスタンスがあればTerminalウィンドウをアクティベートして終了
- **main.sh**: ロックファイルを作成・管理。`trap EXIT INT TERM QUIT`でクリーンアップ
- ランチャーはロックを作成しない（`exec`でプロセスが置き換えられるため`trap`が動作しない）
- Terminal終了時にmain.shの`trap`が発火してロックファイルが削除される

**解決した問題:**
- ロックファイルが残り続ける問題
- プロセス終了後も「既に実行中」と表示される問題
- 2回目起動時に無限にTerminalウィンドウが開く問題

---

## 📝 ドキュメント追加・更新

### 更新されたドキュメント:
1. **README.md / README-EN.md**
   - GUI版([PlayCover Manager GUI](https://github.com/HEHEX8/PlayCoverManagerGUI))へのリンクと推奨を追加
   - CLI版としての位置づけを明確化
   - インストール方法をCLI版用に簡略化

2. **CHANGELOG.md**
   - v5.2.0の変更内容を文書化
   - GUI関連コードの削除を記録

---

## 🔧 内部改善

### 1. **メッセージクリーンアップ**
実際の処理を伴わない不要なメッセージを削除

- `lib/03_storage.sh`の3箇所で「クリーンアップ中...」メッセージを削除
- ユーザーに視覚的フィードバックが明確になるように改善

---

### 2. **容量表示の説明を改善**
内部→外部ストレージ移行完了時のメッセージを改善

- APFSスナップショットによる容量圧迫の説明を追加
- システムメンテナンスメニューへの誘導を追加
- 2つの原因（APFS仕様、Time Machineスナップショット）を明記

---

### 3. **バージョン表記を統一**
5.1.0 → 5.2.0

- `lib/07_ui.sh`
- `main.sh`

---

## 📊 統計

### 主要コミット:
- システムメンテナンス機能: `060fc24`
- GUI関連コードの削除: 最新コミット

---

## 🎯 推奨アップグレード手順

```bash
# 1. 最新コードを取得
git pull origin main

# 2. 実行
./playcover-manager.command
```

---

## ✅ 動作確認済み

- ✅ システムメンテナンスメニューの動作
- ✅ プログレスバー表示の改善
- ✅ CLI版としての全機能動作確認

---

## 🙏 謝辞

v5.2.0は、実際の使用経験とデバッグを通じて改善されました。特に：

- ストレージ容量問題の解決（APFSスナップショット削除）
- プログレスバー表示の改善
- CLI版としての機能強化

このCLI版は、コマンドライン環境を好むユーザー向けに継続して保守されます。
より高度な機能が必要な場合は、[PlayCover Manager GUI](https://github.com/HEHEX8/PlayCoverManagerGUI)の使用を推奨します。
