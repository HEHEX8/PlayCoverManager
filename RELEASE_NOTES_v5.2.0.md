# PlayCover Manager v5.2.0 変更点まとめ

## 📋 v5.1.0 → v5.2.0 の変更内容

---

## 🆕 新機能

### 1. **システムメンテナンスメニュー**
macOSのストレージ容量問題を解決する新機能を追加

- **APFSスナップショットの確認・削除**
  - Time Machineのローカルスナップショットを削除して容量を回復
  - 「幽霊容量」問題の解決（データ削除後も容量が減らない現象）
  
- **システムキャッシュのクリア**
  - ユーザーキャッシュ、一時ファイル、ダウンロード済みアップデートを削除
  
- **ストレージ使用状況の確認**
  - システムボリュームと外部ボリュームの容量を表示

メインメニューに `[6] システムメンテナンス` を追加

---

### 2. **Standalone版アプリビルダー**
Terminal.appに依存しない独立したmacOSアプリケーションを作成

**特徴:**
- ✅ **Terminal ウィンドウで実行**: インタラクティブなUIのためTerminalを使用
- ✅ ターミナルのタイトルを「PlayCover Manager」に設定
- ✅ 外部ツール不要（Platypus不要）
- ✅ 配布用に最適化された.appバンドル構造
- ✅ **シングルインスタンス機能**で複数起動を防止
  - **ランチャー**: ロックファイルを読み取り専用でチェック
  - **main.sh**: ロックファイルを作成・管理、`trap`でクリーンアップ
  - ゾンビロック自動検出と削除
  - 既存Terminalウィンドウの自動アクティベート
  - Terminal終了時の確実なクリーンアップ
- ✅ **アイコンサポート**（macOS標準の`.icns`形式）

**新しいスクリプト:**
- `build-app-standalone.sh` - Standalone版ビルダー
- `create-dmg-standalone.sh` - Standalone版DMG作成

**実際の動作:**
- アプリを起動 → Terminalウィンドウが開く
- タイトルバーに「PlayCover Manager」と表示
- 既に実行中の場合 → 通知を表示 + 既存ウィンドウをアクティベート
- Terminalを閉じる → ロックファイルが自動削除される

---

### 3. **アイコン生成・管理機能**
カスタムアイコンの作成と統合をサポート

- `create-icon.sh` - PNG/JPEGから`.icns`ファイルを生成（macOS上で実行）
- 10種類のサイズ（16x16～1024x1024）を自動生成
- Retina ディスプレイ対応（@2x）
- ビルドスクリプトが自動的に`.icns`を検出・コピー
- `.icns`優先、`.png`フォールバック
- アイコン未生成時の警告メッセージ

---

## 🐛 バグ修正

### 1. **プログレスバー表示の修正**
rsync転送中にリアルタイムでプログレスバーが表示されるように修正

- `monitor_file_progress()`関数の出力を`stderr`にリダイレクト
- プログレスバーが戻り値で上書きされる問題を解決
- `[████████░░] 80% | 4758/5948 files | 52 files/s` 形式で表示

---

### 2. **シングルインスタンス実装の完成**
複数の試行錯誤を経て、正しい実装を達成

**最終的な設計:**
- **ランチャー**: ロックファイルを読み取り専用でチェック。既存インスタンスがあればTerminalウィンドウをアクティベートして終了
- **main.sh**: ロックファイルを作成・管理。`trap EXIT INT TERM QUIT`でクリーンアップ
- ランチャーはロックを作成しない（`exec`でプロセスが置き換えられるため`trap`が動作しない）
- Terminal終了時にmain.shの`trap`が発火してロックファイルが削除される

**解決した問題:**
- ロックファイルが残り続ける問題
- プロセス終了後も「既に実行中」と表示される問題
- 2回目起動時に無限にTerminalウィンドウが開く問題

---

## 📝 ドキュメント追加・更新

### 新規ドキュメント:
1. **ICON_GUIDE.md** - アイコン作成の完全ガイド
   - `create-icon.sh`の使用方法（macOS上で実行）
   - トラブルシューティング
   - Finderキャッシュのクリア方法

2. **STANDALONE_BUILD.md** - Standalone版ビルドの詳細ガイド
   - ビルド方法、テスト手順、配布方法
   - Terminal版との比較

### 更新されたドキュメント:
1. **README.md**
   - Standalone版ビルドの説明を追加
   - アイコン生成手順を追記（`./create-icon.sh`を最初に実行）
   - シングルインスタンス機能の説明

2. **CHANGELOG.md**
   - v5.2.0の全変更内容を文書化
   - 技術的な詳細を記載

---

## 🔧 内部改善

### 1. **メッセージクリーンアップ**
実際の処理を伴わない不要なメッセージを削除

- `lib/03_storage.sh`の3箇所で「クリーンアップ中...」メッセージを削除
- ユーザーに視覚的フィードバックが明確になるように改善

---

### 2. **容量表示の説明を改善**
内部→外部ストレージ移行完了時のメッセージを改善

- APFSスナップショットによる容量圧迫の説明を追加
- システムメンテナンスメニューへの誘導を追加
- 2つの原因（APFS仕様、Time Machineスナップショット）を明記

---

### 3. **バージョン表記を統一**
5.1.0 → 5.2.0

- `lib/07_ui.sh`
- `main.sh`
- `build-app.sh`
- `build-app-standalone.sh`

---

## 📊 統計

### 主要コミット:
- システムメンテナンス機能: `060fc24`
- Standalone版ビルダー: `9aa502b`～`cbbcd5f` (複数回の修正)
- アイコンサポート: `2c189ee`, `597eccd`
- シングルインスタンス修正: `cbbcd5f`（最終版）

### 新規ファイル:
- `build-app-standalone.sh`
- `create-dmg-standalone.sh`
- `appdmg-config-standalone.json`
- `ICON_GUIDE.md`

---

## 🎯 推奨アップグレード手順

```bash
# 1. 最新コードを取得
git pull origin main

# 2. アイコンを生成（macOS上で初回のみ実行）
./create-icon.sh

# 3. Standalone版をビルド
./build-app-standalone.sh

# 4. DMGを作成（配布用）
./create-dmg-standalone.sh

# 5. DMGからインストール
open PlayCover-Manager-5.2.0-Standalone.dmg
# → Applications フォルダにドラッグ
```

---

## ✅ 動作確認済み

- ✅ アイコン付きアプリのビルド成功
- ✅ DMGインストーラーの作成成功
- ✅ Applicationsフォルダへのインストール成功
- ✅ 初回起動成功（Terminalウィンドウが開く）
- ✅ 2回目起動時に通知表示 + 既存ウィンドウアクティベート
- ✅ Terminal終了後、再起動が正常に動作

---

## 🙏 謝辞

v5.2.0は、実際の使用経験とデバッグを通じて改善されました。特に：

- ストレージ容量問題の解決（APFSスナップショット削除）
- 独立したアプリケーションバンドル（Standalone版）
- 正確なシングルインスタンス実装
- プロフェッショナルなアイコンサポート

これらの改善により、より使いやすく、信頼性の高いツールになりました。
