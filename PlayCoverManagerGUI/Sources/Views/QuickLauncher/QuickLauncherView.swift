//
//  QuickLauncherView.swift
//  PlayCoverManagerGUI
//
//  Quick launcher view with app grid
//

import SwiftUI

struct QuickLauncherView: View {
    @StateObject private var viewModel = QuickLauncherViewModel()
    @State private var viewMode: ViewMode = .grid
    @State private var searchText: String = ""
    
    enum ViewMode {
        case grid, list
    }
    
    var filteredApps: [PlayCoverApp] {
        if searchText.isEmpty {
            return viewModel.apps
        } else {
            return viewModel.apps.filter { $0.name.localizedCaseInsensitiveContains(searchText) }
        }
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // Header
            headerView
            
            Divider()
            
            // Content
            if viewModel.isLoading {
                ProgressView("Ë™≠„ÅøËæº„Åø‰∏≠...")
                    .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else if filteredApps.isEmpty {
                emptyStateView
            } else {
                if viewMode == .grid {
                    gridView
                } else {
                    listView
                }
            }
        }
        .alert("„Ç®„É©„Éº", isPresented: $viewModel.showingLaunchError) {
            Button("OK", role: .cancel) { }
        } message: {
            Text(viewModel.errorMessage ?? "‰∏çÊòé„Å™„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü")
        }
        .task {
            await viewModel.refreshApps()
        }
    }
    
    // MARK: - Header
    
    private var headerView: some View {
        HStack {
            Text("üöÄ „ÇØ„Ç§„ÉÉ„ÇØ„É©„É≥„ÉÅ„É£„Éº")
                .font(.title2)
                .bold()
            
            Spacer()
            
            // Search bar
            HStack {
                Image(systemName: "magnifyingglass")
                    .foregroundColor(.secondary)
                TextField("„Ç¢„Éó„É™„ÇíÊ§úÁ¥¢...", text: $searchText)
                    .textFieldStyle(.plain)
                    .frame(width: 200)
                
                if !searchText.isEmpty {
                    Button(action: { searchText = "" }) {
                        Image(systemName: "xmark.circle.fill")
                            .foregroundColor(.secondary)
                    }
                    .buttonStyle(.plain)
                }
            }
            .padding(.horizontal, 8)
            .padding(.vertical, 4)
            .background(Color(nsColor: .controlBackgroundColor))
            .cornerRadius(6)
            
            // View mode toggle
            Picker("", selection: $viewMode) {
                Image(systemName: "square.grid.2x2").tag(ViewMode.grid)
                Image(systemName: "list.bullet").tag(ViewMode.list)
            }
            .pickerStyle(.segmented)
            .frame(width: 100)
            
            // Refresh button
            Button(action: {
                Task {
                    await viewModel.refreshApps()
                }
            }) {
                Image(systemName: "arrow.clockwise")
            }
            .disabled(viewModel.isLoading)
        }
        .padding()
    }
    
    // MARK: - Grid View
    
    private var gridView: some View {
        ScrollView {
            LazyVGrid(
                columns: [
                    GridItem(.adaptive(minimum: 280, maximum: 350), spacing: 16)
                ],
                spacing: 16
            ) {
                ForEach(filteredApps) { app in
                    AppCardView(app: app) {
                        Task {
                            await viewModel.launchApp(app)
                        }
                    }
                    .contextMenu {
                        appContextMenu(app)
                    }
                }
            }
            .padding()
        }
    }
    
    // MARK: - List View
    
    private var listView: some View {
        List(filteredApps) { app in
            AppListRowView(app: app) {
                Task {
                    await viewModel.launchApp(app)
                }
            }
            .contextMenu {
                appContextMenu(app)
            }
        }
    }
    
    // MARK: - Empty State
    
    private var emptyStateView: some View {
        VStack(spacing: 20) {
            Image(systemName: "tray.fill")
                .font(.system(size: 60))
                .foregroundColor(.secondary)
            
            Text("„Ç¢„Éó„É™„Åå„ÅÇ„Çä„Åæ„Åõ„Çì")
                .font(.title2)
                .foregroundColor(.secondary)
            
            Text("PlayCover„ÅßiOS„Ç¢„Éó„É™„Çí„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„Å¶„Åè„Å†„Åï„ÅÑ")
                .font(.body)
                .foregroundColor(.secondary)
            
            Button("„Ç¢„Éó„É™ÁÆ°ÁêÜ„Å∏") {
                AppState.shared.selectedTab = .appManagement
            }
            .buttonStyle(.borderedProminent)
        }
        .frame(maxWidth: .infinity, maxHeight: .infinity)
    }
    
    // MARK: - Context Menu
    
    @ViewBuilder
    private func appContextMenu(_ app: PlayCoverApp) -> some View {
        Button {
            Task {
                await viewModel.launchApp(app)
            }
        } label: {
            Label("Ëµ∑Âãï", systemImage: "play.fill")
        }
        
        Divider()
        
        Button {
            viewModel.openInFinder(app)
        } label: {
            Label("Finder„ÅßË°®Á§∫", systemImage: "folder.fill")
        }
        
        Button {
            viewModel.showAppSettings(app)
        } label: {
            Label("Ë®≠ÂÆö", systemImage: "gearshape")
        }
        
        Divider()
        
        Button(role: .destructive) {
            Task {
                await viewModel.deleteApp(app)
            }
        } label: {
            Label("ÂâäÈô§", systemImage: "trash")
        }
    }
}

#Preview {
    QuickLauncherView()
        .frame(width: 900, height: 600)
}
