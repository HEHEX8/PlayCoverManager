# ストレージ切り替え機能 - 実装詳細

## 概要

外部ストレージで動作に不具合が出るアプリのために、**内蔵ストレージ ⇄ 外部ストレージ** を相互に切り替える機能を追加しました。

---

## 新機能: オプション 6 - ストレージ切り替え（内蔵⇄外部）

### 機能説明

1. **現在のストレージ状態を自動検出**
   - 💾 内蔵ストレージ
   - 🔌 外部ストレージ
   - ❓ 不明 / データなし

2. **双方向の切り替えをサポート**
   - **内蔵 → 外部**: 内蔵のデータを外部ボリュームにコピーしてマウント
   - **外部 → 内蔵**: 外部ボリュームのデータを内蔵にコピーしてアンマウント

3. **安全なデータ移行**
   - rsync を使用した確実なデータコピー
   - 元のデータは自動バックアップ
   - エラー時は自動ロールバック

---

## 実装の詳細

### 追加された関数

#### 1. `get_storage_type()` - ストレージタイプ判定
```bash
get_storage_type "/path/to/directory"
# 返り値: "internal" / "external" / "unknown"
```

**判定ロジック:**
- `df` でパスのデバイスを取得
- `diskutil info` でディスク情報を確認
- "Solid State: Yes" または "Device Location: Internal" → 内蔵
- それ以外 → 外部

#### 2. `is_on_external_volume()` - 外部ボリューム判定
```bash
is_on_external_volume "/path/to/directory"
# 返り値: 0 (true) / 1 (false)
```

#### 3. `switch_storage_location()` - ストレージ切り替えメイン処理

---

## 操作フロー

### ケース1: 内蔵 → 外部ストレージへ移行

```
1. 現在の状態を確認（内蔵ストレージ検出）
   └→ 💾 内蔵ストレージ

2. ユーザー確認
   └→ 「内蔵 → 外部ストレージへ移動」を実行

3. 外部ボリュームの準備
   ├→ ボリュームが既にマウントされている場合はアンマウント
   ├→ 一時マウントポイント作成: /tmp/playcover_temp_$$
   └→ ボリュームを一時マウント

4. データコピー（rsync）
   ├→ 内蔵: ~/Library/Containers/{bundle_id}/
   └→ 外部: /tmp/playcover_temp_$$/

5. 内蔵データをバックアップ
   ├→ 元の場所: ~/Library/Containers/{bundle_id}
   └→ バックアップ: ~/Library/Containers/.{bundle_id}.backup

6. ボリュームを正式にマウント
   ├→ 一時マウントをアンマウント
   └→ ~/Library/Containers/{bundle_id} に再マウント

7. 完了
   └→ バックアップ削除コマンドを表示
```

### ケース2: 外部 → 内蔵ストレージへ移行

```
1. 現在の状態を確認（外部ストレージ検出）
   └→ 🔌 外部ストレージ

2. ユーザー確認
   └→ 「外部 → 内蔵ストレージへ移動」を実行

3. 外部ボリュームのマウント確認
   ├→ マウントされていない場合は一時マウント
   └→ マウントポイントを取得

4. 既存の内蔵データをバックアップ（存在する場合）
   ├→ 元の場所: ~/Library/Containers/{bundle_id}
   └→ バックアップ: ~/Library/Containers/.{bundle_id}.backup

5. データコピー（rsync）
   ├→ 外部: ボリュームマウントポイント/
   └→ 内蔵: ~/Library/Containers/{bundle_id}/

6. 権限設定
   └→ chown -R でユーザー所有権を設定

7. 外部ボリュームをアンマウント
   └→ ボリュームは外部ストレージに残る（削除しない）

8. 完了
   └→ バックアップ削除コマンドを表示
```

---

## 安全機能

### 1. 自動バックアップ
- 移行前のデータは `.{bundle_id}.backup` に自動保存
- 問題が発生した場合に手動で復元可能

### 2. エラーハンドリング
- rsync 失敗時は自動ロールバック
- バックアップから元の状態に復元

### 3. 確認プロンプト
- 操作実行前に必ずユーザー確認
- 時間がかかる旨を警告表示

### 4. 進捗表示
- rsync の `--progress` オプションで進捗を表示
- 最後の20行のみ表示（冗長な出力を抑制）

---

## 使用例

### シナリオ: Zenless Zone Zero が外部ストレージで不具合

```bash
# 1. ボリューム管理スクリプトを起動
./2_playcover-volume-manager.command

# 2. メニューから「6. ストレージ切り替え」を選択

# 3. アプリ一覧が表示される
登録されているボリューム:

  1. 🔌 ゼンレスゾーンゼロ
      (外部ストレージ)

  2. 💾 原神
      (内蔵ストレージ)

選択: 1

# 4. 現在の状態と実行する操作を確認
現在の状態:
  🔌 外部ストレージ

実行する操作: 外部 → 内蔵ストレージへ移動

⚠ この操作には時間がかかる場合があります

続行しますか？ (y/N): y

# 5. データ移行が実行される
ℹ 外部から内蔵ストレージへデータを移行中...
ℹ データをコピー中... (しばらくお待ちください)
[rsync progress output]
✓ データのコピーが完了しました
ℹ ボリュームをアンマウント中...
✓ 内蔵ストレージへの切り替えが完了しました

ℹ 外部データは以下にバックアップされています:
  /Users/xxx/Library/Containers/.com.HoYoverse.Nap.backup

⚠ 問題なく動作することを確認したら、バックアップを削除してください:
  sudo rm -rf "/Users/xxx/Library/Containers/.com.HoYoverse.Nap.backup"
```

---

## 技術的な注意点

### rsync コマンドの使用
```bash
sudo rsync -av --progress "$source/" "$destination/"
```

**オプション説明:**
- `-a` (archive): パーミッション、タイムスタンプ、シンボリックリンクを保持
- `-v` (verbose): 詳細な進捗を表示
- `--progress`: ファイルごとの進捗を表示
- 末尾の `/`: ディレクトリの内容をコピー（ディレクトリ自体ではない）

### ストレージ判定の精度

**内蔵判定基準:**
- `Solid State: Yes` → SSD = 内蔵の可能性が高い
- `Device Location: Internal` → 明示的に内蔵

**外部判定:**
- 上記に該当しない場合 → 外部ストレージ
- USB, Thunderbolt, 外付けSSD などを想定

**注意:** 
- 外付けSSDの場合、`Solid State: Yes` でも外部と判定される
- `Device Location` フィールドが最終的な判断基準

### バックアップファイルの管理

**バックアップ命名規則:**
```
元のパス: ~/Library/Containers/{bundle_id}
バックアップ: ~/Library/Containers/.{bundle_id}.backup
```

**削除タイミング:**
- ユーザーが動作確認後、手動で削除
- 自動削除は行わない（安全性重視）

**削除コマンド例:**
```bash
sudo rm -rf ~/Library/Containers/.com.HoYoverse.Nap.backup
```

---

## テストシナリオ

### テスト1: 内蔵 → 外部（正常系）
- [ ] 内蔵ストレージのアプリを選択
- [ ] 外部ボリュームが存在することを確認
- [ ] データが正常にコピーされる
- [ ] ボリュームが正しくマウントされる
- [ ] バックアップが作成される
- [ ] アプリが正常に起動する

### テスト2: 外部 → 内蔵（正常系）
- [ ] 外部ストレージのアプリを選択
- [ ] データが正常にコピーされる
- [ ] 権限が正しく設定される
- [ ] ボリュームがアンマウントされる
- [ ] バックアップが作成される
- [ ] アプリが正常に起動する

### テスト3: エラーハンドリング
- [ ] 外部ボリュームが見つからない場合
- [ ] ディスク容量不足の場合
- [ ] rsync 失敗時のロールバック
- [ ] ユーザーがキャンセルした場合

### テスト4: 境界ケース
- [ ] データが存在しないアプリ
- [ ] 既にバックアップが存在する場合
- [ ] ボリュームがマウント中の場合
- [ ] 複数回切り替えを実行

---

## 既知の制限事項

1. **大容量データの移行時間**
   - ゲームアプリは数十GBになる場合がある
   - コピーに数分〜数十分かかる可能性

2. **ディスク容量の要件**
   - 移行先に十分な空き容量が必要
   - バックアップ分の容量も考慮

3. **アプリの起動状態**
   - 移行中はアプリを終了しておく必要がある
   - （スクリプトでは強制終了しない）

4. **PlayCover 自体の移行は非対応**
   - PlayCover メインボリュームは対象外
   - アプリボリュームのみが対象

---

## トラブルシューティング

### 問題: 「デバイスまたはリソースがビジー」エラー

**原因:** アプリが起動中、またはファイルが使用中

**解決策:**
1. PlayCover を終了
2. 該当アプリを終了
3. ターミナルで確認: `lsof | grep {bundle_id}`
4. プロセスを強制終了: `sudo pkill -f {bundle_id}`

### 問題: rsync が途中で停止

**原因:** 権限不足、または特殊なファイル

**解決策:**
1. sudo 権限が有効か確認
2. バックアップから復元
3. 手動で rsync を実行して詳細確認

### 問題: 切り替え後にアプリが起動しない

**原因:** データの不整合、または権限問題

**解決策:**
1. バックアップから復元:
   ```bash
   sudo rm -rf ~/Library/Containers/{bundle_id}
   sudo mv ~/Library/Containers/.{bundle_id}.backup ~/Library/Containers/{bundle_id}
   sudo chown -R $(id -u):$(id -g) ~/Library/Containers/{bundle_id}
   ```
2. PlayCover を再起動
3. アプリを再インストール（最終手段）

---

## 今後の改善案

1. **容量チェック機能**
   - 移行前にディスク容量を確認
   - 不足している場合は警告

2. **アプリ起動確認**
   - 移行前にアプリが起動中か確認
   - 起動中の場合は警告または自動終了

3. **進捗バーの改善**
   - より見やすい進捗表示
   - 残り時間の推定

4. **バッチ切り替え**
   - 複数アプリを一括で切り替え
   - 「全て内蔵へ」「全て外部へ」オプション

5. **自動バックアップクリーンアップ**
   - 一定期間後に古いバックアップを自動削除
   - または、ユーザーに削除を促す通知

---

## 更新履歴

### v1.0 (2025-01-XX)
- 初回実装
- 内蔵 ⇄ 外部の双方向切り替え
- 自動バックアップ機能
- エラーハンドリング
