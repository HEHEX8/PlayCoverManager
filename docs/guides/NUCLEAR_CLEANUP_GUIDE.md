# 🔥 超強力クリーンアップ機能 ガイド

## 概要

PlayCover Management Tool v4.21.0 で追加された**超強力クリーンアップ（完全リセット）**機能の説明です。

この機能は、PlayCoverとすべてのアプリを完全に削除し、クリーンな状態に戻します。

## 🎯 この機能が必要な場合

### 症状

- すべてのPlayCoverアプリが即座にクラッシュする
- 外部ボリュームを再マウントするとアプリが起動しなくなる
- アプリの再インストールでは解決しない
- コンテナやボリュームの状態が不整合

### 根本原因

**コンテナとボリュームのメタデータ不整合**

- ボリュームマウント状態とコンテナメタデータの不一致
- 古いメタデータ（`.com.apple.containermanagerd.metadata.plist`など）が残留
- PlayCoverのインストール状態の破損
- APFS volumeのマウント情報の不整合

## ⚠️ 重要な注意事項

### この操作で削除されるもの

1. **すべてのPlayCoverアプリとコンテナ**
   - 原神、ゼンレスゾーンゼロ、崩壊：スターレイル など
   
2. **すべてのAPFSボリューム（内蔵・外部両方）**
   - PlayCoverボリューム
   - すべてのアプリコンテナボリューム
   
3. **PlayCoverの設定・キャッシュ・ログ**
   - `~/Library/Caches/io.playcover.PlayCover`
   - `~/Library/Preferences/io.playcover.PlayCover.plist`
   - `~/Library/Logs/PlayCover`
   
4. **PlayTools.framework**
   - `~/Library/Frameworks/PlayTools.framework`
   
5. **マッピングファイル**
   - `playcover-map.txt`

### 削除されないもの

- **PlayCover.app本体** - `/Applications/PlayCover.app` は削除されません
- **IPAファイル** - ダウンロードしたIPAファイルは残ります
- **ゲームデータ** - miHoYoアカウントに紐付いているため、再ログインで復元できます

## 🚀 使用方法

### ステップ1: 機能の起動

```bash
./PlayCoverManager.command
```

メインメニューから **5** を選択

```
  5. 🔥 超強力クリーンアップ（完全リセット）
```

### ステップ2: 確認

#### 第1確認

```
本当に実行しますか？ (yes/no): yes
```

#### 第2確認（最終）

```
⚠️  最終確認: 'DELETE ALL' と正確に入力してください: DELETE ALL
```

**注意**: `DELETE ALL` を**正確に**入力する必要があります（大文字・小文字・スペース含む）

### ステップ3: 自動実行

以下の処理が自動で実行されます：

#### 【ステップ 1/6】すべてのボリュームをアンマウント

- 実行中のアプリを終了
- すべてのPlayCover関連ボリュームをアンマウント

#### 【ステップ 2/6】すべてのコンテナを削除

- PlayCoverコンテナを削除
- すべてのアプリコンテナを削除

#### 【ステップ 3/6】PlayTools.frameworkを削除

- `~/Library/Frameworks/PlayTools.framework` を削除

#### 【ステップ 4/6】キャッシュと設定を削除

- キャッシュディレクトリを削除
- 設定ファイルを削除
- ログファイルを削除

#### 【ステップ 5/6】APFSボリュームを削除

- すべてのPlayCover関連APFSボリュームを削除
- 内蔵・外部両方のボリュームを削除

#### 【ステップ 6/6】マッピングファイルを削除

- `playcover-map.txt` を削除
- ロックファイルを削除

### ステップ4: 再インストール

クリーンアップ完了後：

1. **PlayCoverアプリを起動**
2. **IPAファイルを再インストール**
3. **アプリを起動して動作確認**

## 📝 トラブルシューティング

### 初回インストール時にPlayCoverがクラッシュする

**これは正常な動作です。**

対処法：
1. PlayCoverを再起動
2. 再度IPAをインストール

### ボリューム削除失敗

エラーメッセージ：
```
⚠ 削除失敗（マウント済み?）
```

対処法：
1. すべてのPlayCoverアプリを終了
2. ターミナルから手動でアンマウント：
   ```bash
   diskutil list | grep -i playcover
   sudo diskutil unmount /dev/diskXsY
   ```
3. 再度超強力クリーンアップを実行

### コンテナ削除失敗

エラーメッセージ：
```
rm: /Users/hehex/Library/Containers/...: Resource busy
```

対処法：
1. すべてのアプリを終了
2. Finderを再起動：
   ```bash
   killall Finder
   ```
3. 再度超強力クリーンアップを実行

## 🔬 技術的詳細

### なぜこの機能が必要なのか

PlayCoverは以下のコンポーネントで構成されています：

1. **コンテナ**: `~/Library/Containers/`
   - macOSのサンドボックス環境
   - メタデータファイルで管理される

2. **APFSボリューム**: カスタムボリューム
   - 内蔵または外部ストレージ
   - マウント情報がシステムに記録される

3. **メタデータファイル**:
   - `.com.apple.containermanagerd.metadata.plist`
   - `PlayChain`, `Sources.plist`, `VERSION`

これらの間で**状態不整合**が発生すると、部分的な削除や再インストールでは解決できません。

### 外部ボリュームの問題

外部ボリュームには**古いメタデータや設定**が残留します。

**問題のシナリオ**:
1. 内蔵ストレージでクリーンインストール成功
2. 外部ボリュームを再マウント
3. **古いメタデータが新しいインストールを汚染**
4. すべてのアプリがクラッシュ

**解決策**:
- 超強力クリーンアップで**外部ボリュームも完全削除**

## 📊 実行例

```
=== PlayCover 統合管理ツール  Version 4.21.0 ===

メインメニュー

  1. アプリ管理
  2. ボリューム操作
  3. ストレージ切り替え（内蔵⇄外部）
  4. 「External SSD」の取り外し
  5. 🔥 超強力クリーンアップ（完全リセット）
  0. 終了

選択 (0-5): 5

===============================================================================
🔥 超強力クリーンアップ（完全リセット）🔥
===============================================================================

⚠️  警告: この操作は以下を完全に削除します：

  • すべてのPlayCoverアプリとコンテナ
  • すべてのAPFSボリューム（内蔵・外部両方）
  • PlayCoverの設定・キャッシュ・ログ
  • マッピングファイル（playcover-map.txt）

⚠️  この操作は取り消せません！

ℹ️  ゲームデータはアカウントに紐付いているため、再インストール後に復元できます

本当に実行しますか？ (yes/no): yes

⚠️  最終確認: 'DELETE ALL' と正確に入力してください: DELETE ALL

─────────────────────────────────────────────────────────────────────────────

ℹ クリーンアップを開始します...

【ステップ 1/6】すべてのボリュームをアンマウント

  アンマウント中: 原神 (disk3s2)
  アンマウント中: PlayCover (disk3s1)
✓ ボリュームアンマウント完了: 2個

【ステップ 2/6】すべてのコンテナを削除

  削除中: PlayCoverコンテナ
  ✓ 削除完了
  削除中: com.miHoYo.GenshinImpact
  ✓ 削除完了
✓ コンテナ削除完了: 2個

【ステップ 3/6】PlayTools.frameworkを削除

  削除中: /Users/hehex/Library/Frameworks/PlayTools.framework
  ✓ 削除完了

【ステップ 4/6】キャッシュと設定を削除

  削除中: io.playcover.PlayCover
  ✓ 削除完了
  削除中: io.playcover.PlayCover.savedState
  ✓ 削除完了
✓ キャッシュと設定削除完了

【ステップ 5/6】APFSボリュームを削除

  削除中: 原神 (disk3s2)
  ✓ 削除完了
  削除中: PlayCover (disk3s1)
  ✓ 削除完了
✓ APFSボリューム削除完了: 2個

【ステップ 6/6】マッピングファイルを削除

  削除中: playcover-map.txt
  ✓ 削除完了

===============================================================================
✅ クリーンアップ完了
===============================================================================

次のステップ:

  1. PlayCoverアプリを起動
  2. IPAファイルを再インストール
  3. アプリを起動して動作確認

⚠️  注意:
  • 初回インストール時にPlayCoverがクラッシュする場合があります
  • その場合は、PlayCoverを再起動して再度IPAをインストールしてください
  • 外部ボリュームの古いデータは完全に削除されました
  • 外部ボリュームを再マウントしても問題ありません

Press Enter to continue...
```

## 🎓 ベストプラクティス

### クリーンアップ前

1. **IPAファイルのバックアップ確認**
   - IPAファイルが別の場所に保存されているか確認

2. **アカウント情報の確認**
   - miHoYoアカウントのログイン情報を確認

### クリーンアップ後

1. **PlayCoverを一度起動**
   - 初期設定を完了させる

2. **IPAを1つずつインストール**
   - 複数のIPAを同時にインストールしない
   - 各IPAのインストール成功を確認

3. **アプリの動作確認**
   - 起動できることを確認
   - ゲームデータが復元されることを確認

## 🔗 関連情報

- **PlayCover Management Tool**: v4.21.0以降
- **対応macOS**: macOS 26 Tahoe (25A362) 以降
- **GitHub**: [リポジトリURL]

## 📞 サポート

問題が発生した場合：

1. このガイドのトラブルシューティングセクションを確認
2. GitHubのIssuesで報告
3. PlayCoverコミュニティDiscordで相談

---

**最終更新**: 2025-10-27  
**バージョン**: 4.21.0
