# PlayCover Volume Manager - クイックリファレンス

## メニュー構成

```
╔═══════════════════════════════════════════════════════════╗
║            PlayCover ボリューム管理                     ║
║              macOS Tahoe 26.0.1 対応版                    ║
╚═══════════════════════════════════════════════════════════╝

━━━━━━━━━━━━━━ メニュー ━━━━━━━━━━━━━━

  1. 全ボリュームをマウント
  2. 全ボリュームをアンマウント
  3. 個別ボリューム操作
  4. ボリューム状態確認
  5. ディスク全体を取り外し
  6. ストレージ切り替え（内蔵⇄外部）  ← 🆕 NEW!
  7. 終了

選択 (1-7):
```

---

## 機能説明

### オプション 1: 全ボリュームをマウント
- PlayCover メインボリューム + 全アプリボリュームをマウント
- 自動的に正しい位置 (`~/Library/Containers/{bundle_id}`) にマウント
- `-o nobrowse` フラグでFinderに表示されない

### オプション 2: 全ボリュームをアンマウント
- 全アプリボリューム + PlayCover メインボリュームをアンマウント
- 安全にアンマウントし、必要に応じて強制アンマウント

### オプション 3: 個別ボリューム操作
- アプリごとにマウント/アンマウント/再マウントを選択
- **自動機能**: IPAボリュームをマウントする際、PlayCoverメインボリュームも自動マウント
- 状態表示:
  - ✅ 正常にマウント済み
  - ⚠️  別の場所にマウント中
  - ⭕ アンマウント済み
  - ❌ ボリューム見つからない

### オプション 4: ボリューム状態確認
- 全ボリュームの現在の状態を一覧表示
- マウントポイントの確認
- 問題があるボリュームの検出

### オプション 5: ディスク全体を取り外し
- 外部ディスク全体を安全に取り外し
- 全ボリュームを自動アンマウント
- 物理的な取り外し前に実行推奨

### オプション 6: ストレージ切り替え（内蔵⇄外部）🆕
- **内蔵ストレージ → 外部ストレージ**
  - 内蔵のデータを外部ボリュームにコピー
  - 外部ボリュームを自動マウント
  - 元の内蔵データは自動バックアップ
  
- **外部ストレージ → 内蔵ストレージ**
  - 外部ボリュームのデータを内蔵にコピー
  - 外部ボリュームを自動アンマウント
  - 元の外部データは残る

- **使用例**: 外部ストレージで不具合が出るアプリを内蔵に移動

### オプション 7: 終了
- スクリプトを終了

---

## ストレージ状態アイコン

| アイコン | 意味 | 説明 |
|---------|------|------|
| 💾 | 内蔵ストレージ | データは Mac の内蔵ストレージに保存 |
| 🔌 | 外部ストレージ | データは外部ディスクのボリュームに保存 |
| ❓ | 不明 | ストレージタイプを判定できない |
| ❌ | データなし | データディレクトリが存在しない |

---

## 典型的な使用フロー

### シナリオ1: 外部ディスク接続後の初回起動
```
1. スクリプト起動
2. オプション 1 (全ボリュームをマウント) を選択
3. 管理者パスワードを入力
4. 全ボリュームがマウントされる
5. PlayCover を起動してゲームをプレイ
```

### シナリオ2: Mac をスリープ前
```
1. PlayCover とゲームを終了
2. スクリプト起動
3. オプション 5 (ディスク全体を取り外し) を選択
4. ディスクを物理的に取り外す
5. Mac をスリープ
```

### シナリオ3: 特定のアプリだけ起動したい
```
1. スクリプト起動
2. オプション 3 (個別ボリューム操作) を選択
3. 起動したいアプリの番号を入力
4. マウントを選択 (PlayCover も自動マウント)
5. 該当アプリのみ起動
```

### シナリオ4: 外部ストレージで不具合が出るアプリ
```
1. スクリプト起動
2. オプション 6 (ストレージ切り替え) を選択
3. 問題のあるアプリを選択
4. 「外部 → 内蔵」への移行を確認
5. データが内蔵ストレージにコピーされる
6. アプリを起動して動作確認
7. 問題なければバックアップを削除
```

---

## よくある質問

### Q1: ボリュームがFinderに表示されないのは正常？
**A:** はい、正常です。`-o nobrowse` フラグでデスクトップとFinderから隠されています。

### Q2: PlayCover メインボリュームも切り替えられる？
**A:** いいえ、現在の実装ではアプリボリュームのみが対象です。PlayCover 本体は対象外です。

### Q3: ストレージ切り替えにどのくらい時間がかかる？
**A:** アプリのデータサイズによります。原神（60GB）の場合、10-30分程度かかる可能性があります。

### Q4: 切り替え中に失敗したらどうなる？
**A:** 自動的にロールバックされ、元の状態に戻ります。バックアップからの復元も可能です。

### Q5: バックアップはいつ削除すべき？
**A:** 切り替え後、アプリが正常に動作することを確認してから削除してください。

### Q6: 外部ディスクを抜いたらどうなる？
**A:** macOS がボリュームの切断を検出します。再接続後、オプション1で再マウントしてください。

### Q7: 複数の外部ディスクを使える？
**A:** 技術的には可能ですが、現在のスクリプトは単一ディスクを想定しています。

---

## トラブルシューティング

### 問題: 「Resource busy」エラーでマウントできない
**解決策:**
```bash
# 既存のマウントを確認
mount | grep PlayCover

# プロセスを確認
lsof | grep Containers

# PlayCover を終了してから再試行
```

### 問題: ボリュームが見つからない
**解決策:**
```bash
# ボリュームの存在確認
diskutil list | grep PlayCover

# ディスクが認識されているか確認
diskutil list

# 外部ディスクを再接続
```

### 問題: 権限エラー
**解決策:**
```bash
# sudo 権限を確認
sudo -v

# ディレクトリの所有権を修正
sudo chown -R $(id -u):$(id -g) ~/Library/Containers/{bundle_id}
```

### 問題: データが消えた？
**解決策:**
```bash
# バックアップの場所を確認
ls -la ~/Library/Containers/ | grep backup

# バックアップから復元
sudo mv ~/Library/Containers/.{bundle_id}.backup ~/Library/Containers/{bundle_id}
```

---

## 緊急時のコマンド

### 全ボリュームを強制アンマウント
```bash
sudo umount -f ~/Library/Containers/io.playcover.PlayCover
sudo umount -f ~/Library/Containers/com.miHoYo.GenshinImpact
sudo umount -f ~/Library/Containers/com.HoYoverse.hkrpgoversea
sudo umount -f ~/Library/Containers/com.HoYoverse.Nap
```

### マッピングファイルの編集
```bash
nano ~/playcover-map.txt
# または
open -e ~/playcover-map.txt
```

### ディスクを強制取り出し
```bash
diskutil list | grep PlayCover
sudo diskutil eject /dev/disk5  # 該当するディスクIDに変更
```

### バックアップを全削除
```bash
sudo rm -rf ~/Library/Containers/.*.backup
```

---

## スクリプトの配置

```
webapp/
├── 0_playcover-initial-setup.command       # 初期セットアップ
├── 1_playcover-ipa-install.command         # IPA インストール
├── 2_playcover-volume-manager.command      # ボリューム管理（このスクリプト）
├── playcover-map.txt                        # ボリュームマッピング
└── docs/
    ├── CHANGELOG.md                         # 変更履歴
    ├── STORAGE_SWITCH_FEATURE.md           # ストレージ切り替え機能詳細
    ├── QUICK_REFERENCE.md                  # このファイル
    └── TEST_SUMMARY.md                     # テスト概要
```

---

## 更新情報

### 最新バージョン: v1.3 (2025-01-XX)

**新機能:**
- ✨ ストレージ切り替え機能（内蔵⇄外部）
- 🔄 自動ストレージタイプ検出
- 💾 安全なデータ移行とバックアップ
- 🎨 ストレージ状態の視覚的表示

**改善:**
- 🚀 PlayCover メインボリューム自動マウント
- 🎯 エラーハンドリングの強化
- 📊 進捗表示の改善

**バグ修正:**
- 🐛 Zenless Zone Zero マウント失敗の修正
- 🐛 ボリュームマネージャーのループ早期終了の修正
- 🐛 zsh 予約変数 `status` の競合解決

---

## サポート

問題が発生した場合:
1. `CHANGELOG.md` で既知の問題を確認
2. `STORAGE_SWITCH_FEATURE.md` で詳細な実装を確認
3. GitHub Issues で報告（該当する場合）

---

**Last Updated:** 2025-01-XX  
**Compatible with:** macOS Tahoe 26.0.1  
**Script Version:** v1.3
