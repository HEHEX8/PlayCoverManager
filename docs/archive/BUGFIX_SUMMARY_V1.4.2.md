# Bug Fix Summary - v1.4.2

## 問題
**空のディレクトリが「内蔵ストレージ」と誤認識される**

## 実際の状況
```bash
# ディレクトリは空
$ ls ~/Library/Containers/com.miHoYo.GenshinImpact
(空 - ファイルなし)

# でも「内蔵ストレージ」と表示される
オプション4 → 💾 原神 (内蔵ストレージ)  ← 誤検知！
```

## 原因

### v1.4.1 での部分的な修正
- `mount_volume()` 関数のみ修正
- `get_storage_type()` 関数は未修正のまま

### `get_storage_type()` の問題
```bash
1. 空のディレクトリが存在
2. マウントポイントではない
3. df コマンド実行
   → 親ディレクトリ（内蔵ディスク）の情報を返す
4. → "internal" と判定 ❌
```

## 修正内容 (v1.4.2)

### `get_storage_type()` に空チェック追加
```bash
# 新規追加部分
if [[ -d "$path" ]]; then
    if [[ -z "$(ls -A "$path" 2>/dev/null)" ]]; then
        echo "none"  # 空 = アンマウント済み
        return
    fi
fi
```

### 新しい状態: `none`
| 状態 | 意味 | アイコン |
|------|------|---------|
| external | 外部ボリュームとしてマウント中 | 🔌 |
| internal | 内蔵ストレージにデータあり | 💾 |
| **none** | **アンマウント済み（空）** | **⚪** |
| unknown | パスが存在しない | ❓ |

## 修正結果

### オプション 4: ボリューム状態確認
**Before (v1.4.1):**
```
💾 原神
   (内蔵ストレージ)  ← 誤検知
```

**After (v1.4.2):**
```
⚪ 原神
   (アンマウント済み)  ← 正しい
```

### オプション 6: ストレージ切り替え
**Before (v1.4.1):**
```
現在の状態: 💾 内蔵ストレージ  ← 誤検知
実行する操作: 内蔵 → 外部ストレージへ移動
続行しますか？
```

**After (v1.4.2):**
```
現在の状態: ⚪ アンマウント済み（データなし）

✗ ストレージ切り替えを実行できません

推奨される操作:
  1. メインメニューのオプション3で外部ボリュームをマウント
  2. その後、このストレージ切り替え機能を使用
```

## チェック順序（修正後）

```
1. パス存在？
   No → "unknown"
   
2. マウントポイント？
   Yes → "external"
   
3. 空ディレクトリ？
   Yes → "none"  ← 新規追加
   
4. 実データあり
   → ディスク情報で判定（"internal" or "external"）
```

## 影響範囲
✅ オプション 4: 状態表示が正確に  
✅ オプション 6: 誤操作を防止  
✅ すべての `get_storage_type()` 呼び出し元  

## テスト結果

### ✓ アンマウント後
```
v1.4.1: 💾 内蔵ストレージ ❌
v1.4.2: ⚪ アンマウント済み ✓
```

### ✓ 実データあり（内蔵）
```
v1.4.1: 💾 内蔵ストレージ ✓
v1.4.2: 💾 内蔵ストレージ ✓
```

### ✓ マウント中（外部）
```
v1.4.1: 🔌 外部ストレージ ✓
v1.4.2: 🔌 外部ストレージ ✓
```

## バージョン情報
- **Version**: 1.4.2
- **Date**: 2025-01-15
- **Type**: Bug Fix
- **Changes**: 
  - `get_storage_type()` に空チェック追加
  - 新状態 `none` 導入
  - UI 改善（⚪ アイコン）

## アップグレード
- ファイルを置き換えるだけ
- データ影響なし
- 表示が正確になる

## まとめ
✅ 空ディレクトリの正確な検出  
✅ 誤った状態表示を修正  
✅ 不適切な操作を防止  
✅ ユーザー体験が向上
