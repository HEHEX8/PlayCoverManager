# PlayCover Management Tool v4.21.0 リリースノート

## 🔥 メジャーアップデート: 超強力クリーンアップ機能

**リリース日**: 2025年10月27日

---

## 🎯 新機能

### 超強力クリーンアップ（完全リセット）

メインメニューに新しいオプション **5. 🔥 超強力クリーンアップ（完全リセット）** を追加しました。

この機能は、すべてのPlayCoverアプリがクラッシュする問題を解決するための最終手段です。

#### 機能概要

以下を**完全に削除**します：

1. **すべてのボリューム**（内蔵・外部両方）
   - PlayCoverボリューム
   - すべてのアプリコンテナボリューム

2. **すべてのコンテナ**
   - `~/Library/Containers/io.playcover.PlayCover`
   - すべてのアプリコンテナ

3. **PlayTools.framework**
   - `~/Library/Frameworks/PlayTools.framework`

4. **キャッシュと設定**
   - `~/Library/Caches/io.playcover.PlayCover`
   - `~/Library/Preferences/io.playcover.PlayCover.plist`
   - `~/Library/Logs/PlayCover`

5. **APFSボリューム**（物理削除）
   - 内蔵ストレージのボリューム
   - 外部ストレージのボリューム

6. **マッピングファイル**
   - `playcover-map.txt`

#### 二重確認システム

誤操作を防ぐため、以下の二重確認が必要です：

1. **第1確認**: `yes` と入力
2. **第2確認**: `DELETE ALL` と正確に入力（大文字・小文字・スペース含む）

#### 実行後の動作

- ゲームデータはアカウントに紐付いているため、再ログインで復元可能
- PlayCover.app本体は削除されません
- IPAファイルは残ります

---

## 🐛 修正された問題

### 外部ボリューム再マウント時のクラッシュ問題

**問題の詳細**:
- 内蔵ストレージでクリーンインストールが成功しても、外部ボリュームを再マウントするとすべてのアプリがクラッシュ
- 外部ボリュームに残った古いメタデータが新しいインストールを汚染
- コンテナとボリュームの状態不整合

**解決方法**:
- 超強力クリーンアップで**外部ボリュームのデータも完全削除**
- APFSボリューム自体を物理削除することで、古いメタデータを完全に除去

### コンテナメタデータの不整合

**問題の詳細**:
- `.com.apple.containermanagerd.metadata.plist`
- `PlayChain`, `Sources.plist`, `VERSION`
- これらのファイルが古い状態で残留すると、新しいインストールと整合性が取れない

**解決方法**:
- すべてのコンテナを完全削除
- ボリュームのアンマウントを確実に実行してから削除

---

## 📊 技術的詳細

### 実装内容

#### 6ステップのクリーンアップ処理

1. **ステップ1**: すべてのボリュームをアンマウント
   - 実行中のアプリを終了
   - diskutilを使用してすべてのPlayCover関連ボリュームを検出
   - 順次アンマウント

2. **ステップ2**: すべてのコンテナを削除
   - `sudo rm -rf` で完全削除
   - PlayCoverコンテナ、アプリコンテナを削除

3. **ステップ3**: PlayTools.frameworkを削除
   - `~/Library/Frameworks/PlayTools.framework`

4. **ステップ4**: キャッシュと設定を削除
   - Caches、Preferences、Logs

5. **ステップ5**: APFSボリュームを削除
   - `diskutil apfs deleteVolume` で物理削除
   - 内蔵・外部両方のボリューム

6. **ステップ6**: マッピングファイルを削除
   - `playcover-map.txt`
   - `playcover-map.txt.lock`

#### 安全機能

- **二重確認**: 誤操作を防止
- **sudo認証**: ユーザーの明示的な許可
- **進捗表示**: 各ステップの成功/失敗を明示
- **詳細なログ**: 何が削除されたかを記録

---

## 📝 使用方法

### 基本的な使用フロー

```bash
# 1. Management Toolを起動
./PlayCoverManager.command

# 2. メインメニューで5を選択
選択 (0-5): 5

# 3. 警告を確認して yes を入力
本当に実行しますか？ (yes/no): yes

# 4. 最終確認で DELETE ALL を入力
⚠️  最終確認: 'DELETE ALL' と正確に入力してください: DELETE ALL

# 5. 自動実行（約1-2分）
【ステップ 1/6】すべてのボリュームをアンマウント
...
✅ クリーンアップ完了

# 6. PlayCoverを起動してIPAを再インストール
```

### 詳細なガイド

`NUCLEAR_CLEANUP_GUIDE.md` に詳細な手順とトラブルシューティングを記載しています。

---

## ⚠️ 重要な注意事項

### この機能を使用する前に

1. **IPAファイルのバックアップ確認**
   - IPAファイルが別の場所に保存されているか確認

2. **アカウント情報の確認**
   - miHoYoアカウントのログイン情報を確認

3. **データの復元可能性**
   - ゲームデータはアカウントに紐付いているため復元可能
   - しかし、ローカル設定は失われます

### この機能を使用すべき場合

✅ **使用を推奨**:
- すべてのアプリが即座にクラッシュする
- 外部ボリューム再マウント後にクラッシュする
- アプリの再インストールでは解決しない
- コンテナの状態が明らかに不整合

❌ **使用を推奨しない**:
- 一部のアプリのみがクラッシュする（個別に対処可能）
- ネットワークエラーなど、他の原因が考えられる
- まだ他の解決策を試していない

---

## 🔄 バージョン比較

### v4.20.2 → v4.21.0

**追加機能**:
- 🔥 超強力クリーンアップ（完全リセット）
- 二重確認システム
- 6ステップの詳細なクリーンアップ処理
- APFS物理ボリューム削除

**変更点**:
- メインメニューに選択肢5を追加
- メニューの選択範囲を (0-4) → (0-5) に変更

**バグ修正**:
- 外部ボリューム再マウント時のクラッシュ問題を完全解決
- コンテナメタデータの不整合問題を解決

---

## 📚 ドキュメント

### 新規追加

- `NUCLEAR_CLEANUP_GUIDE.md` - 超強力クリーンアップ機能の詳細ガイド
  - 使用方法
  - トラブルシューティング
  - 技術的詳細
  - ベストプラクティス

### 更新

- `README.md` - v4.21.0の情報を追加
  - 更新履歴に新バージョン追加
  - トラブルシューティングセクション更新
  - 関連ファイルリスト更新

---

## 🎓 学んだこと（開発者向け）

### macOSコンテナの仕組み

- コンテナは単なるディレクトリではなく、macOSが管理するサンドボックス環境
- `.com.apple.containermanagerd.metadata.plist` が重要な役割
- ボリュームマウント状態では削除できない (`Resource busy`)

### APFS volumeの管理

- APFSボリュームはマウント/アンマウント状態が重要
- 不整合が発生すると、再インストールだけでは解決しない
- 物理削除（`diskutil apfs deleteVolume`）が必要

### トラブルシューティングの鉄則

- 部分的な修正ではなく、**完全なクリーンアップ**が効果的
- 順序が重要: アンマウント → 削除 → 再インストール
- 外部ボリュームの古いデータも**完全削除**が必要

---

## 🔗 関連リンク

- **GitHub**: [リポジトリURL]
- **ガイド**: `NUCLEAR_CLEANUP_GUIDE.md`
- **README**: `README.md`

---

## 👏 謝辞

この機能は、実際のユーザー報告に基づいて開発されました。

特に、macOS 26 Tahoe環境での徹底的なテストと、外部ボリューム再マウント問題の発見に感謝します。

---

**開発者**: PlayCover Management Tool Development Team  
**リリース日**: 2025年10月27日  
**バージョン**: 4.21.0
