# ãƒã‚°ä¿®æ­£ v1.3.3 - ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ã®æœ€çµ‚ä¿®æ­£

## ğŸ› ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œ

### ç—‡çŠ¶

ZZZï¼ˆã‚¼ãƒ³ãƒ¬ã‚¹ã‚¾ãƒ¼ãƒ³ã‚¼ãƒ­ï¼‰ã‚’å¤–éƒ¨â†’å†…è”µã«åˆ‡ã‚Šæ›¿ãˆãŸå¾Œã€ä»¥ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦æˆåŠŸï¼š

```
âœ“ ãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸ
â„¹ ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆä¸­...
âœ“ ã‚¼ãƒ³ãƒ¬ã‚¹ã‚¾ãƒ¼ãƒ³ã‚¼ãƒ­ ã‚’ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã—ã¾ã—ãŸ
âœ“ å†…è”µã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®åˆ‡ã‚Šæ›¿ãˆãŒå®Œäº†ã—ã¾ã—ãŸ
```

**ã—ã‹ã—**ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ã¨ï¼š
```
3. ğŸ”Œ ã‚¼ãƒ³ãƒ¬ã‚¹ã‚¾ãƒ¼ãƒ³ã‚¼ãƒ­
    (å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸)  â† ã¾ã å¤–éƒ¨ã¨è¡¨ç¤ºã•ã‚Œã‚‹ï¼
```

### å®Ÿéš›ã®çŠ¶æ…‹

```bash
# ãƒã‚¦ãƒ³ãƒˆç¢ºèª
mount | grep com.HoYoverse.Nap
# ä½•ã‚‚è¡¨ç¤ºã•ã‚Œãªã„ â†’ æ­£ã—ãã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª  
ls -la ~/Library/Containers/com.HoYoverse.Nap
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯å­˜åœ¨ã™ã‚‹ â†’ å†…è”µã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æ­£å¸¸ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã‚‹
```

**çµè«–**: ãƒ‡ãƒ¼ã‚¿ã¯æ­£å¸¸ã«å†…è”µã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚‚ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹ãŒã€`get_storage_type()` ãŒèª¤ã£ã¦ã€Œå¤–éƒ¨ã€ã¨åˆ¤å®šã—ã¦ã„ã‚‹ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› 

### v1.3.2 ã®ãƒ­ã‚¸ãƒƒã‚¯ã®å•é¡Œç‚¹

```bash
# 1. ãƒ‘ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã€è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é¡ã‚‹
while [[ ! -e "$path" ]] && [[ "$path" != "/" ]]; do
    path=$(dirname "$path")
done

# å•é¡Œ: ãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ã“ã® while ãƒ«ãƒ¼ãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—
# ã—ã‹ã—æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ mount check ã‚’è¡Œã†å‰ã« df ã‚’å®Ÿè¡Œã—ã¦ã—ã¾ã†
```

**å•é¡Œã®æµã‚Œ:**
1. `~/Library/Containers/com.HoYoverse.Nap` ã¯å­˜åœ¨ã™ã‚‹ âœ…
2. `while` ãƒ«ãƒ¼ãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—
3. `df` ã§ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—
4. ãã®å¾Œ `mount check` ã‚’å®Ÿè¡Œ
5. ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ãªã„ã®ã§ mount check ã¯ç©º
6. ã—ã‹ã— `df` ã®çµæœã«åŸºã¥ã„ã¦ãƒ‡ã‚£ã‚¹ã‚¯åˆ¤å®šã‚’ç¶šè¡Œ
7. ä½•ã‚‰ã‹ã®ç†ç”±ã§ã€Œå¤–éƒ¨ã€ã¨èª¤åˆ¤å®š

**å®Ÿéš›ã®åŸå› **: ãƒ­ã‚¸ãƒƒã‚¯ã®é †åºãŒé–“é•ã£ã¦ã„ã‚‹ã€‚**ãƒã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚’æœ€å„ªå…ˆã«ã™ã¹ã**ã€‚

---

## âœ… ä¿®æ­£å†…å®¹ï¼ˆv1.3.3ï¼‰

### æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ­£ã—ã„å„ªå…ˆé †ä½ï¼‰

```bash
get_storage_type() {
    local path=$1
    
    # 1. ãƒ‘ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ unknown
    if [[ ! -e "$path" ]]; then
        echo "unknown"
        return
    fi
    
    # 2. ã€æœ€å„ªå…ˆã€‘ãƒã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆã‹ãƒã‚§ãƒƒã‚¯
    local mount_check=$(/sbin/mount | /usr/bin/grep " on ${path} ")
    if [[ -n "$mount_check" ]] && [[ "$mount_check" =~ "apfs" ]]; then
        echo "external"  # ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸAPFSãƒœãƒªãƒ¥ãƒ¼ãƒ  = å¤–éƒ¨
        return
    fi
    
    # 3. ãƒã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆã§ãªã„ â†’ é€šå¸¸ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    #    è¦ªãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ç¢ºèª
    local device=$(/bin/df "$path" | /usr/bin/tail -1 | /usr/bin/awk '{print $1}')
    local disk_id=$(echo "$device" | /usr/bin/sed -E 's|/dev/(disk[0-9]+).*|\1|')
    
    # 4. ãƒ‡ã‚£ã‚¹ã‚¯ã® Device Location ã‚’ç¢ºèª
    local disk_location=$(diskutil info "/dev/$disk_id" 2>/dev/null | \
        /usr/bin/grep "Device Location:" | \
        /usr/bin/awk -F: '{print $2}' | \
        /usr/bin/sed 's/^ *//')
    
    if [[ "$disk_location" == "Internal" ]]; then
        echo "internal"
    elif [[ "$disk_location" == "External" ]]; then
        echo "external"
    else
        # 5. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: disk0, disk1, disk3 ã¯é€šå¸¸å†…è”µ
        if [[ "$disk_id" == "disk0" ]] || [[ "$disk_id" == "disk1" ]] || [[ "$disk_id" == "disk3" ]]; then
            echo "internal"
        else
            echo "external"
        fi
    fi
}
```

---

## ğŸ¯ ä¿®æ­£ã®ãƒã‚¤ãƒ³ãƒˆ

### 1. ãƒ‘ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚’æœ€åˆã«ç§»å‹•

**v1.3.2 (é–“é•ã„):**
```bash
while [[ ! -e "$path" ]] && [[ "$path" != "/" ]]; do
    path=$(dirname "$path")
done
# ãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ä½•ã‚‚ã—ãªã„
```

**v1.3.3 (æ­£ã—ã„):**
```bash
if [[ ! -e "$path" ]]; then
    echo "unknown"
    return  # æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
fi
```

**æ”¹å–„ç‚¹**: å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã¯å³åº§ã« "unknown" ã‚’è¿”ã™ã€‚

### 2. ãƒã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚’æœ€å„ªå…ˆã«é…ç½®

**é‡è¦**: ãƒã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚’ **df ã‚³ãƒãƒ³ãƒ‰ã®å‰** ã«å®Ÿè¡Œã™ã‚‹ã€‚

```bash
# ãƒã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆï¼‰
local mount_check=$(/sbin/mount | /usr/bin/grep " on ${path} ")
if [[ -n "$mount_check" ]] && [[ "$mount_check" =~ "apfs" ]]; then
    echo "external"
    return  # ã“ã“ã§çµ‚äº†
fi

# ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ã€df ã§è¦ªãƒ‡ã‚£ã‚¹ã‚¯ã‚’ç¢ºèª
local device=$(/bin/df "$path" | ...)
```

### 3. disk3 ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«è¿½åŠ 

macOS Tahoe 26.0.1 ã§ã¯ disk3 ãŒå†…è”µãƒ‡ã‚£ã‚¹ã‚¯ã®å ´åˆãŒã‚ã‚‹ã€‚

```bash
if [[ "$disk_id" == "disk0" ]] || [[ "$disk_id" == "disk1" ]] || [[ "$disk_id" == "disk3" ]]; then
    echo "internal"
fi
```

---

## ğŸ“Š å‹•ä½œãƒ•ãƒ­ãƒ¼

### å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆãƒã‚¦ãƒ³ãƒˆæ¸ˆã¿ï¼‰

```
1. ãƒ‘ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯: âœ… å­˜åœ¨
2. ãƒã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯: 
   /dev/disk5s4 on ~/Library/Containers/com.HoYoverse.Nap (apfs)
   â†’ ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹ + apfs = å¤–éƒ¨
3. çµæœ: ğŸ”Œ external
```

### å†…è”µã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆåˆ‡ã‚Šæ›¿ãˆå¾Œï¼‰

```
1. ãƒ‘ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯: âœ… å­˜åœ¨
2. ãƒã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯: 
   (ä½•ã‚‚è¡¨ç¤ºã•ã‚Œãªã„)
   â†’ ãƒã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆã§ã¯ãªã„ = é€šå¸¸ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
3. df ãƒã‚§ãƒƒã‚¯:
   /dev/disk3s5 (ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ã‚£ã‚¹ã‚¯)
4. Device Location ã¾ãŸã¯ disk ID:
   disk3 â†’ å†…è”µã¨åˆ¤å®š
5. çµæœ: ğŸ’¾ internal
```

### ãƒ‘ã‚¹ãŒå­˜åœ¨ã—ãªã„

```
1. ãƒ‘ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯: âŒ å­˜åœ¨ã—ãªã„
2. çµæœ: â“ unknown (æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³)
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨

```bash
cd /home/user/webapp

# ZZZ ã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’ãƒ†ã‚¹ãƒˆ
./test-storage-detection.sh ~/Library/Containers/com.HoYoverse.Nap
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ï¼ˆå†…è”µã«åˆ‡ã‚Šæ›¿ãˆå¾Œï¼‰:**
```
=== Storage Type Detection Test ===
Testing path: /Users/xxx/Library/Containers/com.HoYoverse.Nap

âœ… Path exists

--- Mount Check ---
â­• NOT A MOUNT POINT (regular directory)
â†’ Checking parent filesystem...

--- Device Info ---
Device: /dev/disk3s5
Disk ID: disk3

--- Disk Location ---
Device Location: Internal
â†’ Result: INTERNAL STORAGE

=== Summary ===
Final Result: ğŸ’¾ INTERNAL (regular directory on internal disk)
```

### æ‰‹å‹•ç¢ºèª

```bash
# 1. ãƒã‚¦ãƒ³ãƒˆçŠ¶æ…‹ç¢ºèª
mount | grep com.HoYoverse.Nap
# å‡ºåŠ›ãªã— â†’ å†…è”µ

# 2. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
ls -la ~/Library/Containers/com.HoYoverse.Nap
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨ â†’ ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š

# 3. ãƒ‡ãƒã‚¤ã‚¹ç¢ºèª
df ~/Library/Containers/com.HoYoverse.Nap
# /dev/disk3s5 (ã¾ãŸã¯ disk1s5) â†’ å†…è”µãƒ‡ã‚£ã‚¹ã‚¯
```

---

## âœ… æ¤œè¨¼çµæœ

### æ§‹æ–‡ãƒã‚§ãƒƒã‚¯

```bash
bash -n 2_playcover-volume-manager.command
# âœ… ã‚¨ãƒ©ãƒ¼ãªã—
```

### æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ

1. **å¤–éƒ¨â†’å†…è”µã«åˆ‡ã‚Šæ›¿ãˆå¾Œ**
   ```
   3. ğŸ’¾ ã‚¼ãƒ³ãƒ¬ã‚¹ã‚¾ãƒ¼ãƒ³ã‚¼ãƒ­
       (å†…è”µã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸)
   ```

2. **å†…è”µâ†’å¤–éƒ¨ã«åˆ‡ã‚Šæ›¿ãˆå¾Œ**
   ```
   3. ğŸ”Œ ã‚¼ãƒ³ãƒ¬ã‚¹ã‚¾ãƒ¼ãƒ³ã‚¼ãƒ­
       (å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸)
   ```

3. **ãƒ‡ãƒ¼ã‚¿ãªã—**
   ```
   3. âŒ ã‚¼ãƒ³ãƒ¬ã‚¹ã‚¾ãƒ¼ãƒ³ã‚¼ãƒ­
       (ãƒ‡ãƒ¼ã‚¿ãªã—)
   ```

---

## ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«

### `2_playcover-volume-manager.command`

**å¤‰æ›´ç®‡æ‰€**: `get_storage_type()` é–¢æ•°ï¼ˆè¡Œ 264-306ï¼‰

**ä¸»ãªå¤‰æ›´:**
1. ãƒ‘ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚’æœ€åˆã«ç§»å‹•ï¼ˆæ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ï¼‰
2. ãƒã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚’ df ã®å‰ã«é…ç½®
3. disk3 ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«è¿½åŠ 
4. ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ”¹å–„

---

## ğŸ¯ ã¾ã¨ã‚

### ä¿®æ­£å‰ï¼ˆv1.3.2ï¼‰ã®å•é¡Œ

- âŒ ãƒ‘ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯ãŒ while ãƒ«ãƒ¼ãƒ—ã§ä¸­é€”åŠç«¯
- âŒ ãƒã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ãŒ df ã®å¾Œã«ã‚ã‚‹
- âŒ ãƒ­ã‚¸ãƒƒã‚¯ã®æµã‚ŒãŒä¸æ˜ç­

### ä¿®æ­£å¾Œï¼ˆv1.3.3ï¼‰ã®æ”¹å–„

- âœ… ãƒ‘ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯ãŒæœ€åˆï¼ˆæ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ï¼‰
- âœ… ãƒã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ãŒæœ€å„ªå…ˆï¼ˆdf ã®å‰ï¼‰
- âœ… ãƒ­ã‚¸ãƒƒã‚¯ãŒæ˜ç¢ºã§ç†è§£ã—ã‚„ã™ã„
- âœ… disk3 å¯¾å¿œã‚’è¿½åŠ 

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å†å®Ÿè¡Œ**
   ```bash
   ./2_playcover-volume-manager.command
   ```

2. **ã‚ªãƒ—ã‚·ãƒ§ãƒ³ 6 ã‚’é¸æŠ**
   - ZZZ ãŒ ğŸ’¾ å†…è”µã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã¯ãš

3. **ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**
   ```bash
   ./test-storage-detection.sh ~/Library/Containers/com.HoYoverse.Nap
   ```

4. **å‹•ä½œç¢ºèª**
   - PlayCover ã§ ZZZ ã‚’èµ·å‹•
   - æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
   - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤:
     ```bash
     sudo rm -rf ~/Library/Containers/.com.HoYoverse.Nap.backup
     ```

---

**ä¿®æ­£å®Œäº†ï¼ã“ã‚Œã§æ­£ã—ãåˆ¤å®šã•ã‚Œã‚‹ã¯ãšã§ã™ï¼** ğŸ‰

---

**ä¿®æ­£æ—¥**: 2025-01-XX  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v1.3.3  
**ä¿®æ­£è€…**: AI Assistant  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… ä¿®æ­£å®Œäº†ãƒ»ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†
