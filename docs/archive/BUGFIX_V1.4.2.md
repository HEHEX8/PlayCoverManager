# Bug Fix v1.4.2 - Empty Directory Storage Detection

## 概要
バージョン 1.4.2 では、空のディレクトリを正しく検出し、「内蔵ストレージ」と誤判定されないように修正しました。

---

## 問題の詳細

### v1.4.1 で残っていた問題
**空のディレクトリが「内蔵ストレージ」と誤認識される**

**症状:**
```bash
# 実際の状況
$ ls ~/Library/Containers/com.miHoYo.GenshinImpact
(空 - ファイルなし)

# オプション4 で表示される内容
💾 原神
   (内蔵ストレージ)  ← 誤検知！
```

**原因:**
v1.4.1 では、`mount_volume()` 関数内でのみ空ディレクトリチェックを追加しましたが、`get_storage_type()` 関数は修正されていませんでした。

```bash
# v1.4.1 の get_storage_type() の動作
1. パスが存在する（空のディレクトリ）
2. マウントポイントではない
3. df コマンドでディスク情報取得
   → 親ディレクトリの情報（内蔵ディスク）を返す
4. → "internal" と判定される ❌
```

**影響範囲:**
- オプション 4（ボリューム状態確認）で誤った状態表示
- オプション 6（ストレージ切り替え）で不適切な操作提示
- ユーザーが混乱する原因

---

## 修正内容

### 改善された `get_storage_type()` ロジック

**空ディレクトリの検出を追加:**
```bash
# v1.4.2 の改善コード
get_storage_type() {
    local path=$1
    
    # パスが存在しない場合
    if [[ ! -e "$path" ]]; then
        echo "unknown"
        return
    fi
    
    # マウントポイントチェック（外部ストレージ）
    local mount_check=$(/sbin/mount | /usr/bin/grep " on ${path} ")
    if [[ -n "$mount_check" ]] && [[ "$mount_check" =~ "apfs" ]]; then
        echo "external"
        return
    fi
    
    # ★ 新規追加: 空ディレクトリチェック
    if [[ -d "$path" ]]; then
        if [[ -z "$(ls -A "$path" 2>/dev/null)" ]]; then
            # ディレクトリは存在するが空 = データなし
            echo "none"
            return
        fi
    fi
    
    # 実データがある場合のみディスク情報をチェック
    local device=$(/bin/df "$path" | /usr/bin/tail -1 | /usr/bin/awk '{print $1}')
    local disk_id=$(echo "$device" | /usr/bin/sed -E 's|/dev/(disk[0-9]+).*|\1|')
    
    # ディスクロケーションで判定
    local disk_location=$(diskutil info "/dev/$disk_id" 2>/dev/null | ...)
    
    if [[ "$disk_location" == "Internal" ]]; then
        echo "internal"
    elif [[ "$disk_location" == "External" ]]; then
        echo "external"
    else
        # Fallback logic...
    fi
}
```

### 修正のポイント

**1. 新しい状態: `none`**
- `unknown`: パスが存在しない（ディレクトリ自体がない）
- `none`: パスは存在するがデータなし（空のディレクトリ）
- `internal`: 内蔵ストレージにデータあり
- `external`: 外部ボリュームとしてマウント中

**2. チェック順序の最適化**
```
1. パス存在？ → No: "unknown"
2. マウントポイント？ → Yes: "external"
3. 空ディレクトリ？ → Yes: "none"
4. 実データあり → ディスク情報で判定
```

**3. 表示アイコンの追加**
| 状態 | アイコン | 説明 |
|------|---------|------|
| external | 🔌 | 外部ストレージ（マウント中） |
| internal | 💾 | 内蔵ストレージ |
| none | ⚪ | アンマウント済み |
| unknown | ❓ | 不明 |
| (存在しない) | ❌ | データなし |

---

## 動作比較

### オプション 4: ボリューム状態確認

**v1.4.1 (修正前):**
```
ボリューム状態
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  1. 💾 原神                    ← 誤検知
     (内蔵ストレージ)

  2. 💾 崩壊：スターレイル          ← 誤検知
     (内蔵ストレージ)
```

**v1.4.2 (修正後):**
```
ボリューム状態
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  1. ⚪ 原神                    ← 正しく検出
     (アンマウント済み)

  2. ⚪ 崩壊：スターレイル          ← 正しく検出
     (アンマウント済み)
```

### オプション 6: ストレージ切り替え

**v1.4.1 (修正前):**
```
現在の状態:
  💾 内蔵ストレージ              ← 誤検知

実行する操作: 内蔵 → 外部ストレージへ移動

続行しますか？ (y/N):
```

**v1.4.2 (修正後):**
```
現在の状態:
  ⚪ アンマウント済み（データなし）

✗ ストレージ切り替えを実行できません

理由: データが存在しません（アンマウント済み）

推奨される操作:
  1. メインメニューのオプション3で外部ボリュームをマウント
  2. その後、このストレージ切り替え機能を使用
```

---

## 技術的な詳細

### なぜ `df` は親ディレクトリの情報を返すのか？

**`df` コマンドの動作:**
```bash
# 空のディレクトリに対して df を実行
$ df ~/Library/Containers/com.miHoYo.GenshinImpact
Filesystem     512-blocks      Used Available Capacity  Mounted on
/dev/disk3s5   1953595632 458842896 987668160    32%    /System/Volumes/Data
                                                          ^^^^^^^^^^^^^^^^^^^^^^
                                                          親ディレクトリのファイルシステム
```

**問題:**
- 空のディレクトリ自体にはファイルシステム情報がない
- `df` は親ディレクトリ（`/System/Volumes/Data`）の情報を返す
- この親ディレクトリは常に内蔵ディスク
- → 空のディレクトリも「内蔵」と判定される

**解決策:**
`df` を実行する前に、ディレクトリが空かどうかをチェックする

### `ls -A` による空ディレクトリ判定

```bash
# 完全に空
$ ls -A /empty/dir
(出力なし)

# .DS_Store のみ
$ ls -A /unmounted/dir
.DS_Store
→ これは「データなし」と判定すべきか？
```

**現在の実装:**
- `.DS_Store` などの隠しファイルも「データ」として扱う
- これは保守的なアプローチ（データ損失を防ぐため）
- 実際には `.DS_Store` は macOS が自動生成するメタデータ

**今後の改善案:**
- `.DS_Store` を除外したファイルカウント
- または、特定のディレクトリ（`Data/` など）の存在をチェック

---

## 変更ファイル

### 修正されたファイル
1. **`2_playcover-volume-manager.command`**
   - 関数: `get_storage_type()` (lines 291-341)
     - 空ディレクトリチェックを追加
     - 新しい状態 `none` を返すように修正
   
   - 関数: `show_status()` (lines 920-940)
     - `none` 状態の表示を追加（⚪ アンマウント済み）
   
   - 関数: `switch_storage_location()` (lines 1005-1037)
     - `none` 状態のハンドリングを追加
     - 適切なエラーメッセージと推奨操作を表示

2. **バージョン番号の更新**
   - Version 1.4.1 → 1.4.2

### 影響を受ける機能
- ✅ **オプション 4**: ボリューム状態確認（表示が正確に）
- ✅ **オプション 6**: ストレージ切り替え（不適切な操作を防止）
- ✅ **内部関数**: `get_storage_type()` を使用するすべての箇所

### 影響を受けない機能
- オプション 1: 全ボリュームマウント（mount_volume は v1.4.1 で修正済み）
- オプション 2: 全ボリュームアンマウント
- オプション 3: 個別ボリューム操作
- オプション 5: ディスク取り外し
- オプション 7: 終了

---

## テストケース

### ケース 1: アンマウント後の状態表示
```bash
# 準備
1. 外部ボリュームをマウント
2. アプリを起動してデータ生成
3. アプリを終了
4. 外部ボリュームをアンマウント

# 確認（オプション 4）
v1.4.1: 💾 (内蔵ストレージ) ← 誤検知 ❌
v1.4.2: ⚪ (アンマウント済み) ← 正しい ✓
```

### ケース 2: ストレージ切り替えの試行
```bash
# 準備
1. 外部ボリュームをアンマウント
2. オプション 6 を選択

# 確認
v1.4.1: 「内蔵 → 外部」と表示 ← 誤動作の原因 ❌
v1.4.2: エラーメッセージ + 推奨操作 ← 正しい ✓
```

### ケース 3: 実データがある内蔵ストレージ
```bash
# 準備
1. アプリを内蔵ストレージで起動
2. データを生成
3. アプリを終了

# 確認（オプション 4）
v1.4.1: 💾 (内蔵ストレージ) ← 正しい ✓
v1.4.2: 💾 (内蔵ストレージ) ← 正しい ✓
```

### ケース 4: マウント中の外部ストレージ
```bash
# 準備
1. 外部ボリュームをマウント

# 確認（オプション 4）
v1.4.1: 🔌 (外部ストレージ) ← 正しい ✓
v1.4.2: 🔌 (外部ストレージ) ← 正しい ✓
```

---

## アップグレード手順

### 既存ユーザー向け
v1.4.1 から v1.4.2 へのアップグレードは透過的です。

**必要な操作:**
1. スクリプトファイルを更新
2. 再実行するだけで新しいロジックが適用される

**データ影響:**
- なし（ロジック改善のみ）
- マッピングファイルへの影響なし
- 既存のボリュームへの影響なし

**表示の変化:**
- アンマウント済みのボリュームが ⚪ で表示される
- 誤った「内蔵ストレージ」表示が解消される

---

## バージョン情報

**Version**: 1.4.2  
**Release Date**: 2025-01-15  
**Type**: Bug Fix  

**変更サマリー:**
- 🐛 **修正**: 空ディレクトリを「内蔵ストレージ」と誤検知する問題を解決
- ✨ **改善**: 新しい状態 `none` を追加（アンマウント済み）
- 🎨 **UI**: ⚪ アイコンで視覚的に区別
- 📝 **メッセージ**: ストレージ切り替えで適切なガイダンスを表示

**互換性:**
- ✅ v1.4.1 と完全互換
- ✅ 既存のマッピングデータをそのまま使用可能
- ✅ 動作中のボリュームへの影響なし

---

## まとめ

**v1.4.2 で達成したこと:**
1. ✅ 空ディレクトリの正確な検出
2. ✅ オプション 4 の状態表示が正確に
3. ✅ オプション 6 での誤操作を防止
4. ✅ ユーザー体験の更なる向上

**v1.4.x シリーズの進化:**
- v1.4.0: マウント保護機能の追加
- v1.4.1: 空ディレクトリの自動削除（マウント時）
- v1.4.2: 空ディレクトリの正確な検出（状態表示）

**今後の改善案:**
- `.DS_Store` の除外オプション
- より詳細なデータサイズ表示
- ストレージ使用量の統計情報

**フィードバック:**
問題が解決されない場合や、新しい問題が見つかった場合は報告してください。
