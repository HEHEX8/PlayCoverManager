# PlayCover 外部ストレージ管理スクリプト

macOS Tahoe 26.0.1 対応の PlayCover 外部ストレージ管理スクリプトセット

## 📦 スクリプト一覧

### 0️⃣ `0_playcover-initial-setup.command`
**初期セットアップスクリプト**

PlayCoverの外部ストレージ環境を構築します。

**機能:**
- Apple Silicon Mac の確認
- フルディスクアクセス権限の確認
- Xcode Command Line Tools の確認とインストール
- Homebrew の確認とインストール
- PlayCover の確認とインストール
- 外部ストレージの選択
- PlayCover メインボリュームの作成とマウント
- マッピングファイルの作成

**使用タイミング:** 最初に1回だけ実行

---

### 1️⃣ `1_playcover-ipa-install.command`
**IPA インストールスクリプト**

iOS アプリ（IPA ファイル）を PlayCover にインストールし、専用の外部ボリュームを作成します。

**機能:**
- IPA ファイルの選択（Finder ダイアログ）
- アプリ情報の抽出（日本語名対応）
- アプリ専用ボリュームの作成
- ボリューム作成前の確認プロンプト
- 既存アプリの検出とバージョン比較
- アップデート確認プロンプト
- 自動マウント（正しい位置に）
- PlayCover へのインストール起動
- マッピングファイルへの登録

**使用タイミング:** 新しいアプリをインストールするたび

**対応機能:**
- ✅ 日本語アプリ名の表示
- ✅ 英語名でのボリューム命名
- ✅ バージョン比較によるアップデート判断
- ✅ デスクトップ非表示（nobrowse）

---

### 2️⃣ `2_playcover-volume-manager.command`
**ボリューム管理スクリプト**

PlayCover のボリュームを管理するインタラクティブメニュー。

**機能:**

#### 1. 全ボリュームをマウント
- PlayCover メインボリュームの優先マウント
- 全アプリボリュームの一括マウント
- 誤った位置のボリュームを自動再マウント
- 存在しないボリュームのクリーンアップ確認

#### 2. 全ボリュームをアンマウント
- アプリボリュームの一括アンマウント
- PlayCover メインボリュームのアンマウント
- 結果サマリーの表示

#### 3. 個別ボリューム操作
- リアルタイムステータス表示
  - ✅ 正常にマウント済み
  - ⚠️  別の場所にマウント中
  - ⭕ アンマウント済み
  - ❌ ボリュームが見つからない
- 個別マウント/アンマウント/再マウント
- 存在しないボリュームのマッピング削除

#### 4. ボリューム状態確認
- PlayCover メインボリュームの状態確認
- 全アプリボリュームの詳細状態確認
- 日本語名での分かりやすい表示

#### 5. ディスク全体を取り外し
- 全ボリュームの自動アンマウント
- ディスク情報の表示
- 安全な取り外し確認
- 物理デバイスの取り外し準備

**使用タイミング:** 
- Mac 起動時（ボリュームのマウント）
- Mac シャットダウン前（ボリュームのアンマウント）
- 外部ストレージを取り外す前
- ボリュームの状態確認時

---

## 📄 マッピングファイル

`playcover-map.txt` - ボリュームとアプリの対応関係を記録

**フォーマット（タブ区切り）:**
```
VolumeName	BundleID	DisplayName
PlayCover	io.playcover.PlayCover	PlayCover
ZenlessZoneZero	com.HoYoverse.Nap	ゼンレスゾーンゼロ
HonkaiStarRail	com.HoYoverse.hkrpgoversea	崩壊：スターレイル
```

**特徴:**
- 3列構成（ボリューム名、Bundle ID、表示名）
- 日本語名または英語名を保存
- ボリューム管理スクリプトで自動活用

---

## 🎨 UI デザイン統一

全スクリプトで統一されたUIデザインを採用：

### カラースキーム
- 🟢 **緑色**: 成功メッセージ
- 🔴 **赤色**: エラーメッセージ
- 🟡 **黄色**: 警告メッセージ
- 🔵 **青色**: 情報メッセージ、ヘッダー
- 🔵 **シアン**: セクション見出し（Volume Manager）

### メッセージアイコン
- ✓ 成功
- ✗ エラー
- ⚠ 警告
- ℹ 情報

### ステータスアイコン（Volume Manager）
- ✅ 正常動作中
- ⚠️  異常状態
- ⭕ アンマウント済み
- ❌ 存在しない

### 終了処理
- **成功時**: 3秒後に自動クローズ
- **エラー時**: Enter キー待ち（ログ確認のため）

詳細は `UI-DESIGN.md` を参照

---

## 🚀 使用方法

### 初回セットアップ
1. `0_playcover-initial-setup.command` をダブルクリック
2. 管理者パスワードを入力
3. 外部ストレージを選択
4. 必要なソフトウェアのインストールを確認
5. 完了を待つ

### アプリのインストール
1. `1_playcover-ipa-install.command` をダブルクリック
2. 管理者パスワードを入力
3. IPA ファイルを選択
4. ボリューム作成を確認
5. 既存アプリがあればアップデート確認
6. PlayCover でインストールを完了

### 日常的な管理
1. `2_playcover-volume-manager.command` をダブルクリック
2. メニューから操作を選択
   - **1**: Mac 起動後に実行（全マウント）
   - **2**: Mac シャットダウン前に実行（全アンマウント）
   - **3**: 個別に管理が必要なとき
   - **4**: 状態を確認したいとき
   - **5**: 外部ストレージを取り外すとき

---

## 🔧 技術的な詳細

### マウントオプション
すべてのボリュームは `nobrowse` オプションでマウントされ、Finder のサイドバーやデスクトップに表示されません。

```bash
sudo mount -t apfs -o nobrowse /dev/diskXsY ~/Library/Containers/[BundleID]
```

### ボリューム配置
- **PlayCover メインボリューム**: `~/Library/Containers/io.playcover.PlayCover`
- **アプリボリューム**: `~/Library/Containers/[各アプリのBundleID]`

### 自動修正機能
ボリューム管理スクリプトは、誤った位置にマウントされているボリュームを検出し、自動的に正しい位置に再マウントします。

---

## ⚠️ 注意事項

### 必須要件
- Apple Silicon Mac（M1/M2/M3シリーズ）
- macOS Sequoia 15.1 (Tahoe 26.0.1) 以降
- フルディスクアクセス権限（ターミナル.app）
- 外部ストレージ（USB/Thunderbolt/SSD）

### 推奨事項
- PlayCover を使用する際は必ずボリュームをマウントしてください
- Mac シャットダウン前には必ずボリュームをアンマウントしてください
- 外部ストレージを物理的に取り外す前に「ディスク全体を取り外し」を実行してください

### トラブルシューティング
- **ボリュームが見つからない**: `2_playcover-volume-manager.command` で状態確認
- **マウントエラー**: ボリューム管理スクリプトで再マウントを試行
- **デスクトップに表示される**: 既存のマウントをアンマウントして再マウント
- **アプリが起動しない**: ボリュームが正しくマウントされているか確認

---

## 📚 関連ファイル

- `playcover-map.txt` - ボリュームマッピングデータ
- `playcover-map.txt.bak` - マッピングファイルのバックアップ
- `UI-DESIGN.md` - UIデザイン仕様書
- `/tmp/apfs_create.log` - ボリューム作成ログ
- `/tmp/mount_error.log` - マウントエラーログ

---

## 🔄 更新履歴

### v1.2.1 (最新)
- ✅ 日本語アプリ名の抽出と表示
- ✅ ボリューム作成前の確認プロンプト
- ✅ 既存アプリ検出とアップデート確認
- ✅ マウント位置の自動修正
- ✅ nobrowse オプションによるデスクトップ非表示
- ✅ UI デザインの統一
- ✅ エラー時のEnter待ち（ログ確認用）
- ✅ 成功時の自動クローズ（3秒）

### v1.2.0
- 日本語名抽出機能追加
- ボリューム作成確認プロンプト追加
- 既存アプリ検出機能修正

### v1.1.0
- マウント問題修正（-nomount フラグ追加）
- ボリューム検出方法の改善

### v1.0.0
- 初期リリース

---

## 📝 ライセンス

このプロジェクトは個人利用および学習目的で作成されました。

---

## 🙏 謝辞

- PlayCover Community
- macOS コミュニティ
- すべてのコントリビューター

---

**最終更新:** 2024年（macOS Sequoia 15.1 対応）
