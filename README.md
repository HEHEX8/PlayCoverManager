# PlayCover 外部ストレージ環境構築スクリプト

## プロジェクト概要

macOS Tahoe 26.0.1 (2025年9月15日リリース) 向けに最適化されたPlayCoverの外部ストレージ環境構築スクリプトです。PlayCoverのコンテナデータを外部ストレージに移行し、効率的なストレージ管理を実現します。

## 主要機能

### 実装済み機能

1. ✅ **アーキテクチャ検証** - Apple Silicon Mac専用
2. ✅ **フルディスクアクセス確認** - 必須権限の検証
3. ✅ **依存関係チェック**
   - Xcode Command Line Tools
   - Homebrew
   - PlayCover Community Edition
4. ✅ **スーパーユーザー権限取得** - 事前認証による円滑な処理
5. ✅ **外部ストレージ選択** - 内蔵ストレージを除外した選択UI
6. ✅ **インストール確認プロンプト** - 不足コンポーネントの一括承認
7. ✅ **APFSボリューム作成** - 重複チェック付き
8. ✅ **データ移行とマウント** - データ競合の自動解決
9. ✅ **自動インストール** - 不足コンポーネントの自動セットアップ
10. ✅ **マッピングデータ管理** - `playcover-map.txt`への記録
11. ✅ **自動終了処理** - 5秒後のターミナル自動クローズ

## 使用方法

### 初回実行時のセキュリティ警告について

macOSのGatekeeperにより、初回実行時に以下の警告が表示される場合があります：

```
Appleは、"playcover-setup.command"にMacに損害を与えたり、
プライバシーを侵害する可能性のあるマルウェアが含まれていないことを検証できませんでした。
```

**これは正常な動作です。** 以下の方法で実行できます：

#### 方法1: 右クリックから開く（推奨）

1. `playcover-setup.command` を **右クリック**
2. **「開く」** を選択
3. 確認ダイアログで **「開く」** をクリック
4. 以降は通常のダブルクリックで起動可能になります

#### 方法2: ターミナルから実行

```bash
cd /path/to/script
./playcover-setup.command
```

ターミナルから実行する場合、Gatekeeperの警告は表示されません。

#### 方法3: 隔離属性を削除（上級者向け）

```bash
xattr -d com.apple.quarantine playcover-setup.command
```

### 実行前の準備

1. **フルディスクアクセス権限の付与**
   - システム設定 > プライバシーとセキュリティ > フルディスクアクセス
   - ターミナル.app を追加

2. **外部ストレージの接続**
   - USB/Thunderbolt接続の外部ドライブを準備
   - APFS対応ストレージを推奨

### 実行フロー

1. Apple Silicon Macの確認
2. フルディスクアクセス権限の検証
3. 依存ソフトウェアの存在確認
4. 管理者パスワードの入力
5. 外部ストレージの選択（内蔵・論理ボリュームを除外）
6. 不足コンポーネントのインストール承認
7. PlayCoverボリュームの作成（既存時はスキップ）
8. データ競合時の選択プロンプト
   - 内部データを外部にコピー
   - 外部データを使用（内部を削除）
9. ボリュームのマウント
10. 不足コンポーネントの自動インストール
11. マッピングデータの記録
12. 5秒後に自動終了

## データ構造

### マッピングファイル形式

**ファイル名**: `~/playcover-map.txt`

**形式**: `VolumeName [TAB] BundleID`

**例**:
```
PlayCover	io.playcover.PlayCover
```

### ディレクトリ構成

```
~/Library/Containers/io.playcover.PlayCover/  ← 外部ボリュームマウント先
/Volumes/PlayCover/                            ← 直接アクセス可能
```

## 技術仕様

### 対応環境

- **OS**: macOS Tahoe 26.0.1 (2025年9月15日リリース)
- **アーキテクチャ**: Apple Silicon (arm64) のみ
- **シェル**: zsh (macOS標準)
- **ファイルシステム**: APFS

### 依存ソフトウェア

- Xcode Command Line Tools
- Homebrew (Apple Silicon版)
- PlayCover Community Edition

### セキュリティ要件

- フルディスクアクセス権限（必須）
- 管理者権限（sudo）

## エラーハンドリング

### 自動対応するケース

- ボリューム名の重複 → 既存ボリュームを使用
- マッピングデータの重複 → スキップ
- データ競合 → ユーザー選択プロンプト

### 処理中断するケース

- 非Apple Silicon Mac
- フルディスクアクセス権限なし
- 外部ストレージ未接続
- インストール承認の拒否
- ユーザーによるキャンセル（Ctrl+C）

### 終了処理

- 正常終了/キャンセル問わず5秒後に自動クローズ
- 成功メッセージの表示
- sudo認証の自動クリーンアップ

## 次のステップ

### 推奨される追加機能

1. **ボリューム管理ツールの開発**
   - マッピングデータを活用した管理UI
   - 複数アプリケーションへの対応
   - マウント/アンマウント操作

2. **自動マウントの設定**
   - launchd による起動時自動マウント
   - plist ファイルの生成

3. **バックアップ機能**
   - Time Machine統合
   - 差分バックアップ

## トラブルシューティング

### フルディスクアクセスエラー

```
✗ フルディスクアクセス権限が必要です
```

**解決方法**: システム設定でターミナルに権限を付与

### ボリューム作成エラー

```
✗ ボリュームの作成に失敗しました
```

**解決方法**: 外部ストレージがAPFS対応か確認

### マウントエラー

```
✗ ボリュームのマウントに失敗しました
```

**解決方法**: ディスクユーティリティで外部ドライブを修復

## ライセンスとサポート

### 作成情報

- **作成日**: 2025年10月24日
- **バージョン**: 1.0.0
- **対応OS**: macOS Tahoe 26.0.1

### 使用上の注意

- このスクリプトは外部ストレージへのデータ移行を行います
- 実行前に重要なデータのバックアップを推奨します
- PlayCoverの動作中は実行しないでください

## 変更履歴

### v1.0.0 (2025-10-24)

- 初回リリース
- 全11ステップの実装完了
- macOS Tahoe 26.0.1 完全対応
- zsh構文への完全準拠
