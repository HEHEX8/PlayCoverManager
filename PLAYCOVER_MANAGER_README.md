# PlayCover Integrated Manager v3.0.0

## 📋 概要

PlayCover統合管理ツールは、IPAインストールとボリューム管理を1つのスクリプトに統合した完全版です。

### 統合前の2つのスクリプト

- `1_playcover-ipa-install.command` (v2.0.0) - IPA一括インストール
- `2_playcover-volume-manager.command` (v1.5.12) - ボリューム管理

### 統合版の利点

✅ **単一インターフェース** - すべての機能を1つのメニューから実行  
✅ **衝突解消** - マッピングファイルの排他制御により、競合を防止  
✅ **機能統合** - インストールと管理をシームレスに連携  
✅ **バグ修正継承** - v1.5.12の全修正を含む  
✅ **保守性向上** - 1つのスクリプトで管理が容易

---

## 🚀 主要機能

### 【インストール機能】

#### 1. IPA をインストール（単一）
- 単一のIPAファイルをインストール
- 自動でボリューム作成・マウント
- PlayCoverへの自動インストール

#### 2. IPA を一括インストール（バッチ）
- 複数のIPAファイルを順次処理
- 確認は最初の1回のみ
- エラー発生時も次のファイルを継続

### 【ボリューム管理機能】

#### 3. 全ボリュームをマウント
- 登録された全アプリのボリュームを一括マウント
- PlayCoverメインボリュームも自動マウント
- 成功/失敗の統計表示

#### 4. 全ボリュームをアンマウント
- 登録された全アプリのボリュームを一括アンマウント
- 外部ディスク取り外し前に使用

#### 5. 個別ボリューム操作
- アプリ単位でマウント/アンマウントを制御
- 現在のマウント状態を表示
- インタラクティブなメニュー操作

### 【ストレージ管理機能】

#### 6. ストレージ切り替え（内蔵⇄外部）
- 内蔵ストレージ ⇄ 外部ストレージのデータ移行
- **注意**: v3.0.0では基本機能のみ（完全実装は次バージョン予定）

#### 7. ストレージ状態確認
- 各アプリのストレージタイプを表示
- 🔌 外部ストレージ（マウント済み）
- 💾 内蔵ストレージ
- ⚪ データなし（アンマウント済み）

### 【システム機能】

#### 8. ディスク全体を取り外し
- 全ボリュームを自動アンマウント
- 外部ディスクを安全に取り外し

#### 9. マッピング情報を表示
- 登録されたアプリの一覧表示
- ボリューム名・Bundle IDの確認

---

## 📊 技術仕様

### ファイル情報

```
ファイル名: playcover-manager.command
サイズ: 47KB
行数: 1426行
関数数: 45個
バージョン: 3.0.0
```

### 統合された機能

| 機能カテゴリ | 関数数 | 由来 |
|------------|--------|------|
| ユーティリティ | 10 | 共通 |
| マッピング管理 | 6 | 共通（排他制御追加） |
| ボリューム操作 | 6 | Script 2 |
| ストレージ検出 | 2 | Script 2 (v1.5.12) |
| IPAインストール | 8 | Script 1 |
| ボリューム管理 | 6 | Script 2 |
| メニューUI | 5 | 新規 |
| メイン実行 | 2 | 新規 |

### 主要な改善点

#### 1. マッピングファイルの排他制御

```bash
# ロックメカニズム実装
acquire_mapping_lock() {
    while ! mkdir "$MAPPING_LOCK_FILE" 2>/dev/null; do
        sleep 0.1
        # タイムアウト処理
    done
}

release_mapping_lock() {
    rmdir "$MAPPING_LOCK_FILE" 2>/dev/null || true
}
```

**効果**: 2つのスクリプトの同時実行による競合を防止

#### 2. 統一されたマウント処理

Script 2のマウント保護機能を採用:

```bash
mount_volume() {
    # マウント保護チェック
    if [[ 内蔵データが存在 ]] && [[ force != true ]]; then
        print_error "マウントがブロックされました"
        # データ保護のため中断
        return 1
    fi
    
    # マウント実行
    sudo diskutil mount -mountPoint "$target_path" "$device"
}
```

**効果**: 内蔵データの誤上書きを防止

#### 3. ストレージタイプ検出（v1.5.12）

```bash
get_storage_type() {
    local container_path=$1  # ← zsh path変数衝突を回避
    
    # 1. マウントポイントチェック（外部判定）
    # 2. ディレクトリ内容チェック（メタデータフィルタリング）
    # 3. ディスク位置チェック（内蔵/外部判定）
    
    echo "internal" | "external" | "none" | "unknown"
}
```

**効果**: 正確なストレージタイプ判定

---

## 🐛 継承されたバグ修正

### v1.5.6: grep固定文字列マッチング
- 正規表現パターンの不安定性を解消
- `grep -v -x -F` フラグで確実なフィルタリング

### v1.5.7: 外付け→内蔵コピー修正
- コピー前のアンマウント問題を解決
- 一時マウントポイント経由でデータ転送

### v1.5.8: rsyncエラーハンドリング
- Spotlightファイル変更への対応
- 終了コード23/24を部分成功として受け入れ

### v1.5.10: ls単一カラム出力
- `ls -A` → `ls -A1` で確実な1項目/行出力
- パイプ時の複数カラム出力問題を解消

### v1.5.11: ls絶対パス指定
- `ls` → `/bin/ls` でシェルエイリアス回避
- 環境依存性を排除

### v1.5.12: zsh path変数衝突解決 ⭐
- `path` → `container_path` にリネーム
- zshの特殊変数との衝突を回避
- **最も重大なバグ修正**

---

## 📁 ファイル構成

```
webapp/
├── playcover-manager.command        # 統合管理ツール v3.0.0
├── 1_playcover-ipa-install.command  # 旧: IPAインストール v2.0.0
├── 2_playcover-volume-manager.command  # 旧: ボリューム管理 v1.5.12
├── 0_playcover-initial-setup.command   # 初期セットアップ
├── playcover-map.txt                # マッピングファイル
├── debug_genshin_storage.sh         # デバッグツール
├── test_mount_protection.sh         # テストツール
└── BUGFIX_SUMMARY_*.md              # バグ修正履歴
```

---

## 🔧 使用方法

### 初回セットアップ

1. **初期セットアップを実行**:
   ```bash
   ./0_playcover-initial-setup.command
   ```
   - PlayCoverメインボリュームの作成
   - マッピングファイルの初期化

2. **統合ツールを実行**:
   ```bash
   ./playcover-manager.command
   ```

### 基本ワークフロー

#### IPAインストール

1. メニューから **1** または **2** を選択
2. IPAファイルを選択（複数選択可）
3. 自動で以下を実行:
   - IPA情報の抽出
   - APFSボリュームの作成
   - ボリュームのマウント
   - PlayCoverへのインストール
   - マッピングファイルへの登録

#### ボリューム管理

1. メニューから **3-5** を選択
2. 必要な操作を実行:
   - **3**: 全ボリュームを一括マウント
   - **4**: 全ボリュームを一括アンマウント
   - **5**: 個別にマウント/アンマウント

#### ストレージ確認

1. メニューから **7** を選択
2. 各アプリのストレージ状態を確認:
   - 🔌 外部ストレージ（マウント済み）
   - 💾 内蔵ストレージ
   - ⚪ データなし

#### ディスク取り外し

1. メニューから **8** を選択
2. 確認後、全ボリュームをアンマウント
3. 外部ディスクを安全に取り外し

---

## ⚠️ 注意事項

### マウント保護機能

内蔵ストレージにデータが存在する場合、外部ボリュームのマウントはブロックされます：

```
❌ マウントがブロックされました
⚠ このアプリは現在、内蔵ストレージで動作しています

検出されたデータ:
  - Data

外部ボリュームをマウントする前に:
  1. ストレージ切り替え機能（メニュー6）を使用
  2. 「内蔵 → 外部」への切り替えを実行
```

**理由**: 内蔵データの誤上書きを防止

### ストレージ切り替え機能

v3.0.0では基本機能のみ実装されています。完全なストレージ切り替えは次のバージョンで実装予定です。

現在利用可能:
- ✅ ボリュームマウント/アンマウント
- ✅ ストレージタイプ検出
- ⚠️ 内蔵⇄外部の自動データ移行（未実装）

完全な実装が必要な場合は、`2_playcover-volume-manager.command`を使用してください。

### 既存スクリプトとの互換性

統合版は既存スクリプトと**完全に互換性**があります：

- ✅ 同じマッピングファイルを使用
- ✅ 同じボリューム構造
- ✅ 排他制御により衝突を防止

既存スクリプトとの併用も可能ですが、統合版の使用を推奨します。

---

## 🧪 テスト状況

### 実施済みテスト

✅ **マッピングファイル操作**
- 排他制御のロック/アンロック
- 複数プロセスからの同時アクセス

✅ **ストレージ検出**
- 内蔵ストレージの正確な判定
- 外部ストレージの正確な判定
- メタデータファイルのフィルタリング
- zsh環境での動作確認

✅ **マウント保護**
- 内蔵データ存在時のブロック
- フィルタリング後の判定

✅ **ボリューム操作**
- マウント/アンマウントの基本動作
- 一括操作の動作確認

### 未テスト項目

⚠️ **IPAインストールフロー**
- エンドツーエンドのインストールテスト
- バッチインストールの動作確認

⚠️ **ストレージ切り替え**
- 内蔵→外部のデータ移行
- 外部→内蔵のデータ移行

---

## 🐛 既知の問題

### 1. ストレージ切り替え機能の制限

**現象**: v3.0.0ではストレージ切り替えの完全実装なし

**影響**: 内蔵⇄外部の自動データ移行ができない

**回避策**: `2_playcover-volume-manager.command`を使用

**対応予定**: v3.1.0で完全実装

### 2. IPAインストールの未テスト

**現象**: 実環境でのテストが未実施

**影響**: 予期しないエラーの可能性

**回避策**: 重要なIPAは先に`1_playcover-ipa-install.command`でテスト

**対応予定**: ユーザーフィードバック収集後に修正

---

## 📈 今後の開発計画

### v3.1.0 (次期バージョン)

🎯 **ストレージ切り替え機能の完全実装**
- Script 2の`switch_storage_location()`を完全統合
- 内蔵→外部のデータ移行
- 外部→内蔵のデータ移行
- rsyncを使用した高速コピー
- エラーハンドリングの強化

### v3.2.0 (将来バージョン)

🎯 **追加機能**
- ボリュームサイズの表示
- ディスク使用状況の監視
- 自動バックアップ機能
- ログ機能の強化

---

## 🔗 関連ドキュメント

- `BUGFIX_SUMMARY_V1.5.6.md` - grep固定文字列マッチング修正
- `BUGFIX_SUMMARY_V1.5.7.md` - ストレージ切り替え0バイトコピー修正
- `BUGFIX_SUMMARY_V1.5.8.md` - rsyncエラーハンドリング修正
- `BUGFIX_SUMMARY_V1.5.10.md` - ls単一カラム出力修正
- `BUGFIX_SUMMARY_V1.5.11.md` - ls絶対パス指定
- `BUGFIX_SUMMARY_V1.5.12.md` - zsh path変数衝突解決

---

## 📝 ライセンス・クレジット

**開発**: PlayCover Volume Management Project  
**バージョン**: 3.0.0  
**対応OS**: macOS Tahoe 26.0.1 (Big Sur 11.0+)  
**必須環境**: PlayCover.app, Terminal with Full Disk Access

---

## 🙏 謝辞

このプロジェクトは、以下のバグ修正を経て完成しました：

- v1.5.6-1.5.12: ストレージ検出の段階的改善
- v1.5.12: zsh path変数衝突の発見と解決（最重要）

全てのテストとフィードバックに感謝します。

---

**最終更新**: 2025-10-25  
**ドキュメントバージョン**: 1.0.0
