# Installation Detection v5.0.2 - Implementation Details

## 概要
極小アプリ（Via 1.6MB等）が1回の設定ファイル更新のみで完了するケースに対応した検出ロジック。

## 検出パターン

### パターンA: 標準的なアプリ (185MB～3GB)
```
[インストール開始]
  ↓
[1回目のmtime更新] ← 初期設定書き込み
  ↓ 2～6秒
[2回目のmtime更新] ← 完了時の最終書き込み
  ↓
[4秒間の安定性確認] ← ファイルが変更されないことを確認
  ↓
[lsofチェック] ← PlayCoverがファイルにアクセスしていないことを確認（オプション）
  ↓
✅ インストール完了
```

**パラメータ**:
- `check_interval`: 2秒（ポーリング間隔）
- `stability_threshold`: 4秒（安定性判定の閾値）

**検証データ**:
```
umamusume (185.5MB):    2回更新、2秒間隔
Nap (2784MB):           2回更新、6秒間隔
hkrpgoversea (2765MB):  2回更新、6秒間隔
GenshinImpact (3125MB): 2回更新、6秒間隔
```

### パターンB: 極小アプリ (1～10MB)
```
[インストール開始]
  ↓
[1回目のmtime更新] ← 設定書き込み（これが最後）
  ↓
[8秒経過待機] ← 2回目が来ないことを確認
  ↓
[4秒間の安定性確認] ← ファイルが変更されないことを確認
  ↓
✅ インストール完了（シングルアップデートパターン）
```

**パラメータ**:
- `time_since_first_update >= 8`: 1回目から8秒経過で「2回目は来ない」と判定
- `stability_threshold`: 4秒（安定性判定の閾値は同じ）

**検証データ**:
```
Via (1.6MB): 1回のみ更新
```

## 実装詳細

### 変数の役割
```bash
settings_update_count    # 設定ファイルの更新回数（0, 1, 2, ...）
first_update_time        # 1回目の更新が発生した時刻（elapsed秒）
last_stable_mtime        # 前回チェック時のmtime（安定性追跡用）
stable_duration          # mtimeが変化していない累積時間（秒）
```

### 判定フロー

#### Phase 1: 更新回数チェック
```bash
if [[ $settings_update_count -eq 1 ]]; then
    first_update_time=$elapsed  # 記録
fi
```

#### Phase 2: 標準パターン（2回更新）
```bash
if [[ $settings_update_count -ge 2 ]]; then
    # mtimeが変化しない → stable_duration累積
    # stable_duration >= 4秒 → lsofチェック → 完了
fi
```

#### Phase 1b: シングルアップデートパターン（1回のみ）
```bash
elif [[ $settings_update_count -eq 1 ]] && [[ $first_update_time -gt 0 ]]; then
    time_since_first_update=$((elapsed - first_update_time))
    
    # 8秒経過しても2回目が来ない → 極小アプリと判定
    if [[ $time_since_first_update -ge 8 ]]; then
        # mtimeが変化しない → stable_duration累積
        # stable_duration >= 4秒 → 完了
    fi
fi
```

## パラメータ調整の根拠

### check_interval = 2秒
- **理由**: 小IPAの最短間隔（2秒）と大IPAの間隔（6秒）をカバー
- **トレードオフ**: 1秒だと大IPAで誤検知、3秒だと小IPAの検出が遅い

### stability_threshold = 4秒
- **理由**: 2回のポーリング分（2秒×2=4秒）でファイルが変化しなければ安定と判定
- **効果**: 書き込み途中での誤検知を防ぐ

### シングルアップデート判定時間 = 8秒
- **理由**: `stability_threshold × 2` = 4秒×2 = 8秒
- **根拠**: 標準パターンの最短間隔（2秒）の4倍を待つ → 2回目が来ないことを確信
- **効果**: 極小アプリでタイムアウト（300秒）まで待つことを回避

## テスト方法

### 標準アプリのテスト
```bash
# 185MB～3GB範囲のIPAをインストール
# 期待動作: 2回目の更新後、4秒で完了判定
```

### 極小アプリのテスト
```bash
# Via (1.6MB) や類似の小さなIPAをインストール
# 期待動作: 1回目の更新後、12秒（8秒待機+4秒安定性確認）で完了判定
```

### 検証コマンド
```bash
# インストール中のログ出力で確認
tail -f /tmp/ipa_installer.log

# 期待されるログ:
# "📝 設定ファイル更新: 1回目"
# "📝 設定ファイル更新: 2回目" または "⏱️ シングルアップデートパターン検出"
# "✅ インストール完了検出!"
```

## エッジケース

### ケース1: 1回更新後に2回目が遅延する場合
- **状況**: 1回目から9秒後に2回目が来る
- **動作**: 8秒時点でシングルアップデート判定が試みられるが、9秒時点で2回目が来たらPhase 2（標準パターン）に移行
- **結果**: 正常に検出（問題なし）

### ケース2: PlayCoverがクラッシュした場合
- **状況**: 更新途中でPlayCoverが終了
- **動作**: 既存のクラッシュ検出ロジックが作動
- **結果**: クラッシュとして報告され、最終検証が実行される

### ケース3: ファイルシステムの遅延
- **状況**: mtimeの更新がOSレベルで遅延
- **動作**: `stability_threshold=4秒`が遅延を吸収
- **結果**: 安定性確認により誤検知を防ぐ

## 変更履歴

### v5.0.2 (2025-10-29)
- ✅ シングルアップデートパターンの検出を追加（極小アプリ対応）
- ✅ `first_update_time`の記録と追跡を実装
- ✅ 8秒間隔のフォールバックロジックを追加

### v5.0.1 (2025-10-29)
- ✅ 2段階検出システムの導入（更新回数 + 安定性確認）
- ✅ `check_interval`を3秒→2秒に調整（大IPA誤検知対策）
- ✅ `stability_threshold=4秒`の導入

### v5.0.0 (2025-10-29)
- ✅ 設定ファイルの更新回数ベースの検出に移行
- ✅ `settings_update_count >= 2`での完了判定

## 参考データ

### 検証ログ分析結果
```
App                   | IPA Size | Update Count | 1st→2nd Interval
--------------------- | -------- | ------------ | ----------------
umamusume             | 185.5MB  | 2            | 2秒
Nap                   | 2784MB   | 2            | 6秒
hkrpgoversea          | 2765MB   | 2            | 6秒
GenshinImpact         | 3125MB   | 2            | 6秒
Via                   | 1.6MB    | 1            | N/A
```

### CPU使用率パターン
```
App                   | Peak CPU | Avg CPU | 判定への影響
--------------------- | -------- | ------- | -----------
umamusume             | 37%      | 7.8%    | 低
Nap                   | 29%      | 5.3%    | 低
hkrpgoversea          | 14%      | 4.3%    | 低
GenshinImpact         | 23%      | 5.3%    | 低
Via                   | 18%      | 4.8%    | 低
```
**結論**: CPU使用率は判定材料として不安定（ファイル安定性の方が信頼性が高い）

## 結論

v5.0.2の実装により、以下を達成：
1. ✅ 標準的なゲームアプリ（数百MB～数GB）の高速検出
2. ✅ 極小アプリ（数MB）の確実な検出
3. ✅ 大IPAでの誤検知防止（安定性確認）
4. ✅ コードの複雑性を最小限に抑制（約20行の追加のみ）

すべてのユースケースをカバーする堅牢な検出システムが完成。
