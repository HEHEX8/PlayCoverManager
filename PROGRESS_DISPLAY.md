# データ転送の進捗表示

## 概要

ストレージ移行時のデータ転送で、処理内容を表示するモードを実装しました。
「........」が途中で止まって不安になることがありません。

## 表示例

### 少量のファイル（100ファイル以下）

```
📊 転送情報:
  ファイル数: 45
  データサイズ: 2.3GB

🚀 使用ツール: cp

データ転送中...

  📄 10/45 - game_data.db
  📄 20/45 - config.json
  📄 30/45 - screenshot_001.png
  📄 40/45 - replay_data.bin

✅ データのコピーが完了しました
  コピー完了: 45 ファイル (2.3GB)
```

### 中量のファイル（100-500ファイル）

```
📊 転送情報:
  ファイル数: 250
  データサイズ: 8.5GB

🚀 使用ツール: cp

データ転送中...

  📄 50/250 - level_data_001.json
  📄 100/250 - texture_atlas_02.png
  📄 150/250 - audio_bgm_03.mp3
  📄 200/250 - character_model_15.fbx
  📄 250/250 - settings_backup.xml

✅ データのコピーが完了しました
  コピー完了: 250 ファイル (8.5GB)
```

### 大量のファイル（500ファイル以上）

```
📊 転送情報:
  ファイル数: 1,523
  データサイズ: 25.7GB

🚀 使用ツール: cp
💡 同期モード: 転送後に余分なファイルを削除

データ転送中...

  📄 100/1523 - game_cache_012.dat
  📄 200/1523 - level_terrain_045.mesh
  📄 300/1523 - particle_effect_128.vfx
  📄 400/1523 - dialogue_voice_jp_256.ogg
  📄 500/1523 - ui_icon_common_512.png
  📄 600/1523 - shader_compiled_768.bin
  ...
  📄 1500/1523 - update_manifest.json

同期モード: 余分なファイルを削除中...
  🗑️  削除中: 10 ファイル...
  🗑️  削除中: 20 ファイル...
  削除完了: 23 ファイル

✅ データのコピーが完了しました
  コピー完了: 1,523 ファイル (25.7GB)
```

## 表示間隔の自動調整

ファイル数に応じて表示頻度を調整します：

| ファイル数 | 表示間隔 | 理由 |
|-----------|---------|------|
| ~100 | 10ファイルごと | 少量なので細かく表示 |
| 100~500 | 50ファイルごと | バランス重視 |
| 500~ | 100ファイルごと | 大量なので間引き |

## ファイル名の表示

- **短いファイル名**: そのまま表示
- **長いファイル名（60文字以上）**: 先頭30文字 + "..." + 末尾27文字

例：
```
通常: game_data.db
長い: very_long_filename_with_many...acters_at_the_end.json
```

## 同期モードの削除表示

外部→内蔵の同期移行時、余分なファイルを削除する際も進捗を表示：

```
同期モード: 余分なファイルを削除中...
  🗑️  削除中: 10 ファイル...
  🗑️  削除中: 20 ファイル...
  🗑️  削除中: 30 ファイル...
  削除完了: 35 ファイル
```

削除がない場合：
```
同期モード: 余分なファイルを削除中...
  削除対象なし（既に同期済み）
```

## 技術詳細

### 実装箇所
- ファイル: `lib/03_storage.sh`
- 関数: `_perform_cp_transfer()`
- 行数: 約440-540行

### 使用コマンド
```bash
# cpの-vオプションで詳細出力
sudo cp -av "$source/" "$dest/"
```

### 進捗カウント
```bash
# パイプで行を読み込みながらカウント
while IFS= read -r line; do
    file_count=$((file_count + 1))
    if (( file_count % show_interval == 0 )); then
        echo "  📄 ${file_count}/${total_files} - ${filename}"
    fi
done
```

## 利点

1. **安心感**: 処理が進んでいることが視覚的にわかる
2. **進捗把握**: 現在何ファイル目かが一目瞭然
3. **問題検知**: 特定のファイルで止まった場合すぐわかる
4. **適応的**: ファイル数に応じて表示頻度を自動調整

## 注意事項

- 表示はファイル数ベース（サイズベースではない）
- 大きなファイル1個より小さなファイル100個の方が表示が多い
- これは仕様です（ファイル操作の回数を反映）
