# PlayCover Complete Manager v4.8.0

## 📋 概要

**PlayCover Complete Manager** は、初回セットアップから日常管理、アプリのインストール・アンインストールまで、すべてを1つのスクリプトで完結する**究極の完全統合版**です。

### 統合されたスクリプト

- `0_playcover-initial-setup.command` (v1.1.0) - 初期セットアップ
- `playcover-manager.command` (v3.1.1) - 統合管理ツール

### 完全統合版の特徴

✅ **ゼロコンフィグ起動** - 初回実行時に自動でセットアップ誘導  
✅ **単一ファイル** - すべての機能が1つのスクリプトに統合  
✅ **環境自動判定** - セットアップ済みか自動で判断  
✅ **既存機能完全継承** - v3.1.1のすべての機能を含む  
✅ **完璧な互換性** - 既存のスクリプトとも並行利用可能

---

## 🚀 クイックスタート

### 初回実行（未セットアップ時）

```bash
./playcover-complete-manager.command
```

自動的に初期セットアップ画面が表示されます：

```
╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║        PlayCover 初回セットアップ                       ║
║                                                           ║
║    このツールを使用するには初期セットアップが必要です        ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝

セットアップには以下が必要です:
  - Apple Silicon Mac
  - ターミナルへのフルディスクアクセス権限
  - Homebrew（未インストールの場合は自動インストール）
  - PlayCover（未インストールの場合は自動インストール）
  - 外部ストレージ（SSD推奨）

初回セットアップを開始しますか？ (Y/n):
```

**Y** を入力すると、`0_playcover-initial-setup.command` が自動実行されます。

### 2回目以降（セットアップ済み）

```bash
./playcover-complete-manager.command
```

通常のメニューが直接表示されます：

```
PlayCover 統合管理ツール

1. IPA を一括インストール
2. 全ボリュームをマウント
3. 全ボリュームをアンマウント
...
```

---

## 🎯 主要機能

### 【自動環境判定】

起動時に以下をチェック：
- PlayCover がインストール済みか
- PlayCover ボリュームが作成済みか
- マッピングファイルが存在するか

**未セットアップの場合**: 自動で初期セットアップに誘導  
**セットアップ済みの場合**: 通常メニューを表示

### 【初期セットアップ機能】（from v1.1.0）

1. アーキテクチャ確認（Apple Silicon）
2. フルディスクアクセス確認
3. Xcode Command Line Tools 確認/インストール
4. Homebrew 確認/インストール
5. PlayCover 確認/インストール
6. 外部ディスク選択
7. PlayCoverボリューム作成
8. PlayCoverコンテナマウント
9. マッピングファイル作成

### 【日常管理機能】（from v3.1.1）

#### アプリ管理機能（v4.4.0 完全版）
- **アプリインストール** - 一括インストール（バッチ処理）対応
- **アプリアンインストール** - 完全削除（Applications + App Settings + Entitlements + Keymapping + Containers + ボリューム + マッピング）
- **全アプリ一括アンインストール** - PlayCoverを含むすべてを一度に削除（NEW!）
- **PlayCover保護** - 他のアプリが残っている間はPlayCoverボリューム削除不可
- **連続アンインストール** - 0個になるまで連続実行可能
- PlayCoverクラッシュ検出と復旧
- **堅牢な完了検出**（3段階検証: 構造+設定ファイル+安定性）

#### ボリューム管理機能
- 全ボリュームの一括マウント/アンマウント
- 個別ボリューム操作
- nobrowseによるデスクトップ非表示

#### ストレージ切り替え機能
- 内蔵⇄外部の双方向データ移行
- **転送前容量チェック**（10%安全マージン）
- **リアルタイム進捗バー**（転送速度・残り時間表示）
- **インタラクティブ検証フロー**（OK/NG確認）
- 自動バックアップ/復元

#### システム機能
- ディスク全体の安全な取り外し
- マッピング情報の表示
- ストレージ状態確認

---

## 📊 技術仕様

### ファイル情報

```
ファイル名: playcover-complete-manager.command
サイズ: 128KB
行数: 3527行
関数数: 49個
バージョン: 4.2.0
```

### 新規追加機能

| 機能 | 説明 |
|------|------|
| `is_playcover_environment_ready()` | 環境が整っているか判定 |
| `run_initial_setup()` | 初期セットアップを実行 |

### IPA インストール検出ロジック (v4.2.1)

```bash
# 3段階検証による堅牢な完了検出（実環境に基づく修正版）

Phase 1: 構造検証
├─ Info.plist の存在確認
├─ CFBundleName の有効性確認
├─ CFBundleShortVersionString の有効性確認
└─ _CodeSignature ディレクトリの存在確認

Phase 2: PlayCover 設定ファイル確認 (MOST RELIABLE)
├─ パス: ~/Library/Containers/io.playcover.PlayCover/App Settings/
├─ ファイル: [Bundle ID].plist の存在確認
└─ PlayCover によるアプリ登録の確認

Phase 3: ファイル安定性確認 (短縮版)
├─ 最新ファイルの mtime 取得
├─ 2回連続で同じ mtime (6秒間安定)
└─ ファイル変更の停止を確認

成功判定: Phase 1 ✓ AND (Phase 2 ✓ OR Phase 3 ✓)
```

**検出ロジックの利点**:
- **最高の信頼性**: PlayCover の実際のファイル構造に基づく検証
- **高速検出**: 設定ファイル確認で即座に完了判定（6秒待機不要）
- **フォールバック対応**: 設定ファイル未作成時は構造+安定性で判定
- **短縮された待機時間**: mtime安定確認が9秒→6秒に短縮
- **実環境ベース**: ユーザー環境の `tree` 出力に基づく正確な実装

### 環境判定ロジック

```bash
is_playcover_environment_ready() {
    # 1. PlayCover.app の存在確認
    # 2. PlayCoverボリュームの存在確認
    # 3. マッピングファイルの存在確認
    
    # すべて満たす → true
    # 1つでも欠けている → false
}
```

### 起動フロー

```
起動
 ↓
環境チェック
 ├─ 未セットアップ → 初期セットアップ実行 → 再チェック → メニュー表示
 └─ セットアップ済み → メニュー表示
```

---

## 🔧 使用方法

### 基本的な使い方

1. **スクリプトをダウンロード**
   ```bash
   # 完全統合版だけでOK
   ./playcover-complete-manager.command
   ```

2. **初回実行（自動セットアップ）**
   - 環境チェック → 未セットアップ検出
   - セットアップ確認 → Y で開始
   - 自動でセットアップ実行
   - 完了後、自動的にメニュー表示

3. **2回目以降（通常使用）**
   - 環境チェック → セットアップ済み検出
   - 直接メニュー表示
   - 各機能を使用

### 必要なファイル

```
webapp/
├── playcover-complete-manager.command  # 本体（必須）
├── 0_playcover-initial-setup.command   # 初期セットアップ（必須）
└── playcover-map.txt                   # マッピングファイル（自動生成）
```

**注意**: `0_playcover-initial-setup.command` が同じディレクトリに必要です。

---

## 🆚 既存スクリプトとの比較

| 項目 | Complete Manager | 既存3スクリプト |
|------|------------------|----------------|
| **ファイル数** | 1個 + セットアップ | 3個 |
| **初回起動** | 自動セットアップ誘導 | 手動で0_を実行 |
| **環境判定** | 自動 | なし |
| **機能** | 完全統合 | 分散 |
| **使いやすさ** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

### 移行方法

**既存ユーザー（セットアップ済み）:**
```bash
# そのまま使えます
./playcover-complete-manager.command
# → 自動的にメニューが表示されます
```

**新規ユーザー:**
```bash
# これだけでOK
./playcover-complete-manager.command
# → 初回セットアップが自動で始まります
```

---

## 🐛 トラブルシューティング

### 初期セットアップスクリプトが見つからない

```
エラー: 初期セットアップスクリプトが見つかりません
必要なファイル: /path/to/0_playcover-initial-setup.command
```

**対処法**:
1. `0_playcover-initial-setup.command` を同じディレクトリに配置
2. 実行権限を付与: `chmod +x 0_playcover-initial-setup.command`

### 環境チェックが失敗する

**PlayCoverがインストール済みなのに検出されない:**
- `/Applications/PlayCover.app` に存在するか確認
- アプリケーションフォルダへのシンボリックリンクではないか確認

**ボリュームが作成済みなのに検出されない:**
```bash
# ボリューム確認
diskutil info PlayCover

# 存在しない場合は再作成が必要
```

---

## 📈 変更履歴

### v4.2.0 (2025-10-25) - Robust Installation Detection

**改善点**: IPA インストール完了検出の大幅強化

**新しい検出方式（3段階検証）**:
1. **Phase 1: 構造検証**
   - Info.plist の存在と有効性確認
   - _CodeSignature ディレクトリの存在確認
   - CFBundleName と CFBundleShortVersionString の取得確認

2. **Phase 2: PlayCover データベース確認**（最も信頼性が高い）
   - PlayCover.sqlite から Bundle ID の登録を確認
   - PlayCover内部の状態を直接チェック
   - データベースアクセス失敗時は構造検証のみで判定

3. **Phase 3: 安定性確認**（短縮版）
   - ファイル修正時間（mtime）の安定確認
   - 従来の9秒から6秒に短縮（2チェック × 3秒）
   - より高速な検出を実現

**成功判定基準**: Phase 1 + (Phase 2 OR Phase 3)
- データベース登録が確認できれば即座に成功判定
- データベースチェック失敗時は安定性確認で判定
- より確実で高速な検出を実現

**利点**:
- PlayCoverの内部状態を直接確認（最も信頼性が高い）
- 検出時間の短縮（9秒 → 6秒、またはDB確認で即座）
- 複数の検証方法によるフォールバック対応
- クラッシュ時の検証も同様に強化

### v4.1.0 (2025-10-25) - True Standalone

**改善点**: 完全自己完結型へ進化
- 外部依存の完全排除
- 13個のセットアップ関数を直接統合
- 単一ファイルですべて完結

### v4.0.0 (2025-10-25) - Initial Release

**新機能**: 完全統合版
- 初期セットアップの自動判定・誘導
- 環境チェック機能の追加
- 単一ファイルですべてが完結

**統合内容**:
- 0_playcover-initial-setup.command v1.1.0 のロジックを統合
- playcover-manager.command v3.1.1 の全機能を継承

---

## 🔗 関連ドキュメント

- `PLAYCOVER_MANAGER_README.md` - playcover-manager.command の詳細
- 初期セットアップスクリプトのドキュメント

---

## 💡 推奨される使い方

### 新規ユーザー

```bash
# 1. これだけ実行
./playcover-complete-manager.command

# 2. 初回セットアップに従う（自動）
# 3. 以降は通常のメニューから使用
```

### 既存ユーザー（playcover-manager.command 使用中）

```bash
# 既存のスクリプトと並行利用可能
# complete版を試したい場合:
./playcover-complete-manager.command

# 既存版を使い続ける場合:
./playcover-manager.command

# どちらも同じマッピングファイルを使用
# データは完全共有
```

---

## 🎉 まとめ

**PlayCover Complete Manager v4.2.0** は:
- ✅ 初心者に優しい（自動セットアップ）
- ✅ 上級者も満足（全機能統合）
- ✅ 既存ユーザーも安心（完全互換）
- ✅ メンテナンスしやすい（単一ファイル）
- ✅ **最も確実なインストール検出**（PlayCover DB直接確認）

**究極の完全統合版、さらに進化！** 🚀
