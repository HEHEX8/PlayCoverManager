# PlayCover Complete Manager v4.3.1 変更ログ

## リリース日: 2025-10-25

## 🎯 主要な改善: アンインストール機能の強化とUI改善

### 背景
v4.3.0では、アプリ管理メニューとして階層化していましたが、ユーザーからの要望により：
1. **トップメニューに直接配置** - サブメニューに入らず、直接アクセス可能に
2. **完全削除** - PlayCoverコンテナ内のすべての関連ファイルを削除
3. **連続アンインストール** - 最後のアプリまで連続して削除可能

### 実装した改善

#### 1. メニュー構造の簡素化

**変更前 (v4.3.0):**
```
▼ メインメニュー
  1. アプリ管理メニュー  → サブメニュー表示
     ├─ 1. IPAをインストール
     └─ 2. アプリをアンインストール
```

**変更後 (v4.3.1):**
```
▼ メインメニュー
【アプリ管理】
  1. IPAをインストール          ← 直接アクセス
  2. アプリをアンインストール    ← 直接アクセス
```

**メリット:**
- クリック数が減少（2クリック → 1クリック）
- より直感的な操作
- メインメニューの情報密度向上

#### 2. PlayCover完全クリーンアップ

**実際のPlayCoverコンテナ構造に基づく削除:**
```bash
~/Library/Containers/io.playcover.PlayCover/
├── Applications/
│   └── [BundleID].app              # Step 1: 削除
├── App Settings/
│   └── [BundleID].plist            # Step 2: 削除
├── Entitlements/
│   └── [BundleID].plist            # Step 3: 削除 (NEW!)
└── Keymapping/
    └── [BundleID].plist            # Step 4: 削除 (NEW!)
```

**v4.3.0との比較:**

| ファイル | v4.3.0 | v4.3.1 |
|---------|--------|--------|
| Applications/ | ✓ | ✓ |
| App Settings/ | ✓ | ✓ |
| Entitlements/ | ✗ | ✓ (NEW) |
| Keymapping/ | ✗ | ✓ (NEW) |
| APFSボリューム | ✓ | ✓ |
| マッピング | ✓ | ✓ |

#### 3. 連続アンインストール機能

**新しいフロー:**
```
1回目のアンインストール完了
↓
「残り 2 個のアプリがインストールされています」
↓
「続けて別のアプリをアンインストールしますか？ (y/N):」
↓
y → 再度アプリ一覧表示
N → メインメニューに戻る
↓
最後のアプリを削除
↓
「すべてのアプリがアンインストールされました」
→ メインメニューに戻る
```

**特徴:**
- ✅ 0個になるまで連続実行可能
- ✅ 各アンインストール後に残数を表示
- ✅ 任意のタイミングで中断可能
- ✅ 最後のアプリ削除時に完了メッセージ

### コード変更箇所

**ファイル**: `playcover-complete-manager.command`

1. **メインメニュー表示の変更** (lines 2236-2248)
   ```bash
   # v4.3.0
   【アプリ管理】
   1. アプリ管理メニュー → サブメニュー
   
   # v4.3.1
   【アプリ管理】
   1. IPAをインストール
   2. アプリをアンインストール
   ```

2. **メインループの更新** (lines 3232-3265)
   ```bash
   case "$choice" in
       1) install_workflow ;;        # 直接呼び出し
       2) uninstall_workflow ;;      # 直接呼び出し
       3) mount_all_volumes ;;       # 番号シフト
       ...
   ```

3. **app_management_menu() 削除**
   - サブメニュー関数を削除（不要に）
   - コードの簡素化

4. **uninstall_workflow() の強化** (lines 2351-2605)
   ```bash
   # 新規追加: ループ構造
   while true; do
       # アプリ一覧表示
       # アンインストール処理
       
       # NEW: Entitlements削除
       rm -f "Entitlements/${bundle_id}.plist"
       
       # NEW: Keymapping削除
       rm -f "Keymapping/${bundle_id}.plist"
       
       # NEW: 連続実行確認
       if [[ 残りアプリ > 0 ]]; then
           echo "続けて別のアプリをアンインストールしますか？"
       else
           echo "すべてのアプリがアンインストールされました"
           break
       fi
   done
   ```

### 削除処理の詳細

#### Step-by-Stepプロセス

```
アンインストール開始
├─ Step 1: Applications/[BundleID].app 削除
├─ Step 2: App Settings/[BundleID].plist 削除
├─ Step 3: Entitlements/[BundleID].plist 削除  ← NEW
├─ Step 4: Keymapping/[BundleID].plist 削除    ← NEW
├─ Step 5: APFSボリュームのアンマウント
├─ Step 6: APFSボリュームの削除
└─ Step 7: マッピング情報の削除

アンインストール完了
├─ 削除したアプリ名を表示
├─ 残りアプリ数を表示
└─ 連続実行確認
```

#### エラーハンドリング

各ステップで：
- ✓ ファイル/ディレクトリの存在確認
- ✓ 削除失敗時の適切なエラーメッセージ
- ✓ すでに削除済みの場合は警告表示
- ✓ 致命的エラー時は処理中断

### バージョン更新内容

```
v4.3.0 → v4.3.1
- 行数: 3276行 → 3283行 (+7行)
- サイズ: 118KB → 119KB (+1KB)
- 削除関数: app_management_menu() (不要に)
- 強化関数: uninstall_workflow() (ループ + 完全削除)
- 変更: show_menu(), main()
```

### 使用シーン

#### シーン1: すべてのアプリを削除
```
ユーザー: 「すべてのテストアプリを削除したい」
→ メインメニュー → 2. アプリをアンインストール
→ アプリ1を削除 → 「続けますか？」→ y
→ アプリ2を削除 → 「続けますか？」→ y
→ アプリ3を削除 → 「すべて削除されました」
```

#### シーン2: トップメニューから直接アクセス
```
# v4.3.0（旧）
メインメニュー → 1. アプリ管理 → 2. アンインストール

# v4.3.1（新）
メインメニュー → 2. アプリをアンインストール
```
**操作ステップ: 3回 → 2回**

#### シーン3: 完全削除の確認
```
削除前のPlayCoverコンテナ:
Applications/com.example.app.app
App Settings/com.example.app.plist
Entitlements/com.example.app.plist
Keymapping/com.example.app.plist

削除後:
（すべて削除される）
```

### ユーザーへの影響

**ポジティブな影響:**
- ✅ メニュー操作が簡素化（1ステップ削減）
- ✅ PlayCover関連ファイルを完全削除
- ✅ 連続削除で効率アップ
- ✅ 0個まで削除可能（ロック解除）
- ✅ より直感的なUI

**技術的改善:**
- ✅ コードの簡素化（app_management_menu削除）
- ✅ 実環境構造に基づく正確な削除
- ✅ ループ構造による柔軟性

### 次回以降の改善案

1. **一括選択削除**
   - チェックボックス形式で複数選択
   - 選択したアプリを一括削除

2. **削除前プレビュー**
   - 削除されるファイルの一覧表示
   - 合計サイズの計算

3. **バックアップオプション**
   - 削除前の自動バックアップ
   - バックアップからの復元機能

---

## まとめ

v4.3.1では、ユーザーフィードバックを元に大幅なUI改善と機能強化を実施しました。

**主な改善点:**
- 【UI改善】サブメニュー廃止 → トップメニューに直接配置
- 【完全削除】Entitlements + Keymapping も削除対象に
- 【連続実行】0個になるまでアンインストール可能

**v4.3.0からの改善:**
```
操作性:   サブメニュー経由 → 直接アクセス（1ステップ削減）
削除:     4項目 → 6項目（Entitlements + Keymapping追加）
連続性:   1回ずつメニューに戻る → 連続実行可能
```

**推奨**: v4.3.0をお使いの方は v4.3.1 へのアップグレードを推奨します。より効率的なアプリ管理が可能になります。
