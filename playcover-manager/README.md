# PlayCover Manager (Modular Version)

## 🚧 開発中 - v5.0.0-alpha1

**注意**: この版は開発中です。本番利用には既存版（`../0_PlayCover-ManagementTool.command`）を使用してください。

## 📦 モジュール構造

### ディレクトリ構成

```
playcover-manager/
├── playcover-manager.command      # メインエントリーポイント
├── lib/                           # ライブラリモジュール
│   ├── 00_core.sh                # ✅ コア機能（422行 - 完成）
│   ├── 01_mapping.sh             # ✅ マッピング管理（172行 - 完成）
│   ├── 02_volume.sh              # ✅ ボリューム操作（260行 - 完成）
│   ├── 03_storage.sh             # ✅ ストレージ管理（1,175行 - 完成）
│   ├── 04_app.sh                 # 🚧 アプリ管理（383行 - 基本完成、install関数未完）
│   ├── 05_cleanup.sh             # ✅ クリーンアップ（405行 - 完成）
│   ├── 06_setup.sh               # 🚧 初期セットアップ（21行 - 未実装）
│   └── 07_ui.sh                  # 🚧 UIとメニュー（16行 - 未実装）
├── tests/                         # テスト（今後実装）
└── README.md                      # このファイル
```

## 🎯 モジュール分割の目的

1. **可読性向上**: 5000行以上の1ファイルを分割
2. **保守性向上**: 関数の場所が明確
3. **テスト容易性**: モジュール単位でテスト可能
4. **再利用性**: 他のスクリプトからimport可能
5. **開発効率**: 複数人での並行開発が可能

## 📋 各モジュールの役割

### 00_core.sh（完成）
- **定数定義**: 色、パス、設定値
- **基本関数**: print_*, wait_for_enter
- **ユーティリティ**: 認証、エラーハンドリング
- **行数**: 約500行

### 01_mapping.sh（✅ 完成）
- マッピングファイルのロック管理（acquire/release）
- マッピングの追加・削除・更新・検索
- 重複検出と削除
- **抽出元**: line 547-685
- **行数**: 170行

### 02_volume.sh（✅ 完成）
- ボリュームの存在確認
- ボリュームデバイスの取得
- マウント・アンマウント操作
- ボリューム作成・削除
- **抽出元**: line 686-769
- **行数**: 260行

### 03_storage.sh（✅ 完成）
- ストレージモード検出（外部/内部/汚染）6状態識別
- 容量計算（使用量・空き容量）バイト単位対応
- 内蔵⇄外部切り替え（完全実装）
- フラグファイル管理
- 移行ヘルパー関数（rsync・容量チェック・エラーハンドリング）
- **抽出元**: line 770-1065, 2900-3771
- **行数**: 1,175行

### 04_app.sh（🚧 基本完成）
- IPAファイル選択（AppleScript dialog、複数選択対応）
- アプリ情報抽出（Info.plist、日本語名対応）
- PlayCoverボリューム管理・マウント
- APFSコンテナ検出
- アプリボリューム作成・マウント
- インストール関数の骨格（TODO: 完全実装）
- **抽出元**: line 1066-1662
- **行数**: 383行

### 05_cleanup.sh（✅ 完成）
- 超強力クリーンアップ（完全リセット）
- 削除プレビュー表示（項目数・詳細表示）
- 2段階確認プロンプト（yes + DELETE ALL）
- 5ステップ実行（unmount→delete→uninstall→clean→summary）
- 隠しオプションアクセス（X/x/RESET/reset）
- **抽出元**: line 2516-2899
- **行数**: 405行

### 06_setup.sh（TODO）
- アーキテクチャチェック
- 環境チェック（Xcode, Homebrew）
- PlayCoverインストール
- ボリューム作成
- 初期マッピング
- **抽出元**: line 4620-5219

### 07_ui.sh（TODO）
- メインメニュー表示
- クイックステータス
- 個別ボリューム操作
- バッチマウント・アンマウント
- **抽出元**: line 1663-2515, 3772-3910, 3916-4619

## 🚀 実装フェーズ

### フェーズ1: 基本構造の作成 ✅
- [x] ディレクトリ構造作成
- [x] コアモジュール完成（00_core.sh）
- [x] スケルトンモジュール作成（01-07）
- [x] メインエントリーポイント作成

### フェーズ2: 段階的移行 🚧
- [x] マッピング管理モジュール実装（01_mapping.sh - 172行）
- [x] ボリューム操作モジュール実装（02_volume.sh - 260行）
- [x] ストレージ管理モジュール実装（03_storage.sh - 1,175行）
  - [x] ストレージ検出ロジック（6状態識別）
  - [x] 容量計算関数（バイト単位対応）
  - [x] フラグ管理
  - [x] UIとメニュー
  - [x] 移行ヘルパー関数（rsync・容量チェック・エラー処理）
- [x] アプリ管理モジュール実装 - 基本完成（04_app.sh - 383行）
  - [x] IPA選択・情報抽出
  - [x] PlayCoverボリューム管理
  - [x] アプリボリューム作成・マウント
  - [ ] install_ipa_to_playcover() 完全実装（進捗監視・バッチ処理）
- [x] クリーンアップモジュール実装（05_cleanup.sh - 405行）
- [ ] セットアップモジュール実装（06_setup.sh）
- [ ] UIモジュール実装（07_ui.sh）

### フェーズ3: テストと検証 ⏳
- [ ] 各モジュールの単体テスト
- [ ] 統合テスト
- [ ] 既存版との機能比較
- [ ] バグ修正

### フェーズ4: 完全移行 ⏳
- [ ] 全機能移行完了
- [ ] ドキュメント更新
- [ ] 既存版をアーカイブ
- [ ] 正式リリース（v5.0.0）

## 🔧 開発者向け情報

### モジュール追加手順

1. `lib/` に新しい `.sh` ファイルを作成
2. shebang（`#!/bin/zsh`）を追加
3. ヘッダーコメントで役割を記述
4. 関数を実装
5. `playcover-manager.command` で source

### コーディング規約

- 関数名: `snake_case`
- 定数: `UPPER_CASE` + `readonly`
- グローバル変数: `UPPER_CASE`
- ローカル変数: `snake_case` + `local`
- インデント: スペース4つ

### テスト方法

```bash
# メインスクリプト実行（開発版）
./playcover-manager.command

# 個別モジュールのテスト（今後実装）
./tests/test_mapping.sh
./tests/test_volume.sh
```

## 📚 関連ドキュメント

- **既存版のドキュメント**: `../README.md`
- **更新履歴**: `../CHANGELOG.md`
- **開発ガイド**: `../docs/development/`

## ⚠️ 注意事項

- **本番環境では使用しない**: 開発中のため動作保証なし
- **既存版を使用**: `../0_PlayCover-ManagementTool.command` が安定版
- **バックアップ必須**: テスト時は必ずバックアップを取る

## 🤝 貢献

このプロジェクトは段階的な移行中です。以下の方法で貢献できます：

1. モジュールの実装
2. バグ報告
3. ドキュメント改善
4. テストケース追加

## 📝 変更履歴

### v5.0.0-alpha1 (2025-10-28)
- 初期モジュール構造作成
- コアモジュール完成（00_core.sh - 422行）
- マッピング管理モジュール完成（01_mapping.sh - 172行）
- ボリューム操作モジュール完成（02_volume.sh - 260行）
- ストレージ管理モジュール完成（03_storage.sh - 1,175行）
  - 検出ロジック、容量計算、フラグ管理
  - 移行ヘルパー関数（rsync・容量チェック・エラー処理）完成
- アプリ管理モジュール基本完成（04_app.sh - 383行）
  - IPA選択・情報抽出・ボリューム管理完成
  - install_ipa_to_playcover() は骨格のみ（次回完成予定）
- クリーンアップモジュール完成（05_cleanup.sh - 405行）
  - 2段階確認・5ステップ実行・隠しオプション完成
- メインエントリーポイント作成

---

**最終更新**: 2025-10-28  
**ステータス**: 開発中（フェーズ2 - 5/8モジュール完成、62.5%完了）
